# ğŸ§¬ Correlation IDs

Request tracing conventions for BlackRoad OS services. Correlation IDs enable tracing a single request across multiple services.

---

## ğŸ¯ Purpose

When a user request touches multiple services (e.g., web â†’ api â†’ database), correlation IDs let you:

1. **Trace** the full request path
2. **Debug** issues across service boundaries
3. **Measure** end-to-end latency
4. **Correlate** logs from different services

---

## ğŸ“‹ ID Types

### Request ID (`X-Request-ID`)

- **Scope**: Single HTTP request
- **Generated by**: First service to receive the request
- **Propagated**: Yes, to all downstream services
- **Format**: `req_[a-z0-9]{20}`
- **Example**: `req_abc123def456ghi789`

### Correlation ID (`X-Correlation-ID`)

- **Scope**: User session or transaction
- **Generated by**: Client or edge service
- **Propagated**: Yes, through entire flow
- **Format**: `corr_[a-z0-9]{20}`
- **Example**: `corr_xyz789abc123def456`

### Trace ID (for OpenTelemetry)

- **Scope**: Distributed trace
- **Generated by**: Tracing library
- **Format**: 32-character hex string
- **Example**: `0af7651916cd43dd8448eb211c80319c`

---

## ğŸ“Š Flow Example

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Request                                                      â”‚
â”‚ X-Correlation-ID: corr_user123session456                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cloudflare Edge                                                   â”‚
â”‚ + CF-Ray: abc123                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ blackroad-os-web (Frontend)                                       â”‚
â”‚ X-Correlation-ID: corr_user123session456                         â”‚
â”‚ X-Request-ID: req_web001                                          â”‚
â”‚                                                                   â”‚
â”‚ LOG: {"requestId":"req_web001","correlationId":"corr_user..."}   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ blackroad-os-api (Backend)                                        â”‚
â”‚ X-Correlation-ID: corr_user123session456 (propagated)            â”‚
â”‚ X-Request-ID: req_api001 (new for this service)                   â”‚
â”‚ X-Parent-Request-ID: req_web001 (upstream request)                â”‚
â”‚                                                                   â”‚
â”‚ LOG: {"requestId":"req_api001","correlationId":"corr_user..."}   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ› ï¸ Implementation

### Express Middleware

```typescript
// middleware/correlationId.ts
import { Request, Response, NextFunction } from 'express';
import { v4 as uuidv4 } from 'uuid';

declare global {
  namespace Express {
    interface Request {
      requestId: string;
      correlationId: string;
      parentRequestId?: string;
    }
  }
}

export function correlationMiddleware(
  req: Request, 
  res: Response, 
  next: NextFunction
) {
  // Get or generate correlation ID (from client or upstream)
  // Using full UUID for better uniqueness (prefix + 32 chars = 37 total)
  const correlationId = req.headers['x-correlation-id'] as string 
    || `corr_${uuidv4().replace(/-/g, '')}`;
  
  // Get parent request ID (from upstream service)
  const parentRequestId = req.headers['x-request-id'] as string;
  
  // Generate new request ID for this service (full UUID)
  const requestId = `req_${uuidv4().replace(/-/g, '')}`;
  
  // Attach to request object
  req.requestId = requestId;
  req.correlationId = correlationId;
  req.parentRequestId = parentRequestId;
  
  // Set response headers
  res.setHeader('X-Request-ID', requestId);
  res.setHeader('X-Correlation-ID', correlationId);
  
  next();
}
```

### Propagating to Downstream Services

```typescript
// When calling other services, propagate IDs
import axios from 'axios';

async function callDownstreamService(req: Request, data: any) {
  return axios.post('https://api.blackroad.io/endpoint', data, {
    headers: {
      'X-Correlation-ID': req.correlationId,
      'X-Request-ID': req.requestId, // Becomes parent for downstream
    },
  });
}
```

### Including in Logs

```typescript
import { logger } from './logger';

function logRequest(req: Request, message: string, extra?: object) {
  logger.info({
    message,
    requestId: req.requestId,
    correlationId: req.correlationId,
    parentRequestId: req.parentRequestId,
    ...extra,
  });
}
```

---

## ğŸ” Searching Logs

With proper correlation IDs, you can trace requests:

```bash
# Find all logs for a specific user session
railway logs | grep "corr_user123session456"

# Find all logs for a specific request
railway logs | grep "req_api001"

# Find the full trace of a correlation
railway logs | jq 'select(.correlationId == "corr_user123session456")'
```

---

## ğŸ“Š Headers Reference

| Header | Direction | Purpose |
|--------|-----------|---------|
| `X-Request-ID` | Both | Unique ID for this request |
| `X-Correlation-ID` | Both | Session/transaction correlation |
| `X-Parent-Request-ID` | Request | Upstream service's request ID |
| `CF-Ray` | Response | Cloudflare trace ID |
| `traceparent` | Both | W3C Trace Context (if using OTel) |

---

## âœ… Best Practices

1. **Always propagate** correlation ID through all service calls
2. **Generate request ID** at each service boundary
3. **Include IDs in every log** entry
4. **Set response headers** so clients can reference the ID
5. **Use consistent format** across all services

---

## ğŸš« Anti-Patterns

- âŒ Generating new correlation ID at each service
- âŒ Not propagating IDs to downstream calls
- âŒ Logging without request context
- âŒ Using different ID formats per service

---

## ğŸ”— Related

- [Logging Conventions](./logging.md)
- [Health Endpoints](./health-endpoints.md)

---

**Last Updated**: 2025-11-25
