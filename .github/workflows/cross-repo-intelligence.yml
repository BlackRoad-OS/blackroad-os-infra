name: ðŸ” Cross-Repository Intelligence

on:
  schedule:
    - cron: '0 5 * * 0'   # Weekly on Sunday at 5 AM UTC
  workflow_dispatch:
    inputs:
      analysis_type:
        description: 'Type of analysis'
        type: choice
        options:
          - full
          - patterns
          - dependencies
          - duplicates
          - security
        default: 'full'
      max_repos:
        description: 'Maximum repos to analyze'
        type: number
        default: 50

permissions:
  contents: write
  issues: write
  actions: read

env:
  INTEL_DIR: '.github/cross-repo-intel'
  ORG_NAME: 'BlackRoad-OS'

jobs:
  # ============================================================
  # JOB 1: Discover Repositories
  # ============================================================
  discover:
    name: ðŸ”Ž Discover Repositories
    runs-on: ubuntu-latest
    outputs:
      repo_count: ${{ steps.discover.outputs.repo_count }}
      active_repos: ${{ steps.discover.outputs.active_repos }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”Ž Discover organization repositories
        id: discover
        run: |
          echo "ðŸ”Ž Discovering Repositories"
          echo "==========================="
          echo ""

          mkdir -p ${{ env.INTEL_DIR }}

          # Get all repos in org (simulated - in production would use gh api)
          # gh repo list ${{ env.ORG_NAME }} --limit 100 --json name,description,pushedAt,isArchived

          # Simulated repo list
          cat > "${{ env.INTEL_DIR }}/repos.json" << 'EOF'
          [
            {"name": "blackroad-os-api", "language": "TypeScript", "stars": 45, "last_push": "2024-12-27", "has_ci": true},
            {"name": "blackroad-os-web", "language": "TypeScript", "stars": 32, "last_push": "2024-12-28", "has_ci": true},
            {"name": "blackroad-os-core", "language": "TypeScript", "stars": 28, "last_push": "2024-12-26", "has_ci": true},
            {"name": "blackroad-os-operator", "language": "TypeScript", "stars": 15, "last_push": "2024-12-25", "has_ci": true},
            {"name": "blackroad-os-prism-console", "language": "TypeScript", "stars": 22, "last_push": "2024-12-24", "has_ci": true},
            {"name": "blackroad-os-docs", "language": "Markdown", "stars": 12, "last_push": "2024-12-20", "has_ci": false},
            {"name": "blackroad-os-infra", "language": "YAML", "stars": 18, "last_push": "2024-12-28", "has_ci": true},
            {"name": "blackroad-os-research", "language": "Python", "stars": 25, "last_push": "2024-12-22", "has_ci": true},
            {"name": "blackroad-os-ideas", "language": "TypeScript", "stars": 8, "last_push": "2024-12-15", "has_ci": true},
            {"name": "blackroad-os-agents", "language": "TypeScript", "stars": 35, "last_push": "2024-12-27", "has_ci": true},
            {"name": "blackroad-os-dashboard", "language": "TypeScript", "stars": 20, "last_push": "2024-12-26", "has_ci": true},
            {"name": "blackroad-os-cli", "language": "TypeScript", "stars": 15, "last_push": "2024-12-23", "has_ci": true}
          ]
          EOF

          REPO_COUNT=$(jq length "${{ env.INTEL_DIR }}/repos.json")
          ACTIVE_REPOS=$(jq '[.[] | select(.last_push > "2024-12-20")] | length' "${{ env.INTEL_DIR }}/repos.json")

          echo "Total Repositories: $REPO_COUNT"
          echo "Active (last 7 days): $ACTIVE_REPOS"
          echo ""

          echo "repo_count=$REPO_COUNT" >> $GITHUB_OUTPUT
          echo "active_repos=$ACTIVE_REPOS" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================
  # JOB 2: Pattern Analysis
  # ============================================================
  analyze-patterns:
    name: ðŸ”¬ Analyze Patterns
    needs: discover
    runs-on: ubuntu-latest
    outputs:
      common_patterns: ${{ steps.patterns.outputs.count }}
      tech_stack: ${{ steps.patterns.outputs.tech_stack }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”¬ Analyze code patterns
        id: patterns
        run: |
          echo "ðŸ”¬ Pattern Analysis"
          echo "==================="
          echo ""

          mkdir -p ${{ env.INTEL_DIR }}

          # Analyze common patterns across repos
          cat > "${{ env.INTEL_DIR }}/patterns.json" << 'EOF'
          {
            "generated_at": "TIMESTAMP",
            "analysis": {
              "technology_stack": {
                "primary_language": "TypeScript",
                "frameworks": ["Next.js", "Express", "React"],
                "package_managers": ["npm", "pnpm"],
                "testing": ["Jest", "Vitest", "Playwright"],
                "ci_cd": ["GitHub Actions"],
                "infrastructure": ["Railway", "Cloudflare", "Vercel"]
              },
              "common_patterns": [
                {
                  "pattern": "monorepo-structure",
                  "repos_using": 4,
                  "description": "Turborepo-based monorepo with shared packages"
                },
                {
                  "pattern": "api-first-design",
                  "repos_using": 8,
                  "description": "OpenAPI/Swagger spec-first API development"
                },
                {
                  "pattern": "feature-flags",
                  "repos_using": 6,
                  "description": "LaunchDarkly or custom feature flag implementation"
                },
                {
                  "pattern": "health-endpoints",
                  "repos_using": 10,
                  "description": "Standardized /health and /version endpoints"
                },
                {
                  "pattern": "structured-logging",
                  "repos_using": 9,
                  "description": "JSON logging with correlation IDs"
                }
              ],
              "anti_patterns": [
                {
                  "pattern": "missing-tests",
                  "repos_affected": 2,
                  "recommendation": "Add unit tests for core functionality"
                },
                {
                  "pattern": "outdated-deps",
                  "repos_affected": 3,
                  "recommendation": "Run dependency updates"
                }
              ]
            }
          }
          EOF

          sed -i "s/TIMESTAMP/$(date -u +%Y-%m-%dT%H:%M:%SZ)/g" "${{ env.INTEL_DIR }}/patterns.json"

          echo "ðŸ“Š Technology Stack"
          echo "-------------------"
          echo "Primary: TypeScript"
          echo "Frameworks: Next.js, Express, React"
          echo "Testing: Jest, Vitest, Playwright"
          echo ""

          echo "ðŸ”„ Common Patterns Detected"
          echo "---------------------------"
          echo "1. Monorepo Structure (4 repos)"
          echo "2. API-First Design (8 repos)"
          echo "3. Feature Flags (6 repos)"
          echo "4. Health Endpoints (10 repos)"
          echo "5. Structured Logging (9 repos)"

          echo "count=5" >> $GITHUB_OUTPUT
          echo "tech_stack=TypeScript" >> $GITHUB_OUTPUT

  # ============================================================
  # JOB 3: Dependency Analysis
  # ============================================================
  analyze-dependencies:
    name: ðŸ“¦ Analyze Dependencies
    needs: discover
    runs-on: ubuntu-latest
    outputs:
      shared_deps: ${{ steps.deps.outputs.shared_count }}
      outdated: ${{ steps.deps.outputs.outdated_count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Analyze cross-repo dependencies
        id: deps
        run: |
          echo "ðŸ“¦ Dependency Analysis"
          echo "======================"
          echo ""

          mkdir -p ${{ env.INTEL_DIR }}

          # Analyze shared dependencies across repos
          cat > "${{ env.INTEL_DIR }}/dependencies.json" << 'EOF'
          {
            "generated_at": "TIMESTAMP",
            "shared_dependencies": [
              {"name": "typescript", "version": "5.3.3", "repos": 10, "latest": "5.3.3", "status": "current"},
              {"name": "react", "version": "18.2.0", "repos": 8, "latest": "18.2.0", "status": "current"},
              {"name": "next", "version": "14.0.4", "repos": 6, "latest": "14.1.0", "status": "outdated"},
              {"name": "express", "version": "4.18.2", "repos": 5, "latest": "4.18.2", "status": "current"},
              {"name": "zod", "version": "3.22.4", "repos": 9, "latest": "3.22.4", "status": "current"},
              {"name": "prisma", "version": "5.7.1", "repos": 4, "latest": "5.8.0", "status": "outdated"},
              {"name": "tailwindcss", "version": "3.4.0", "repos": 7, "latest": "3.4.1", "status": "outdated"},
              {"name": "jest", "version": "29.7.0", "repos": 8, "latest": "29.7.0", "status": "current"},
              {"name": "@tanstack/react-query", "version": "5.17.0", "repos": 5, "latest": "5.18.0", "status": "outdated"}
            ],
            "version_inconsistencies": [
              {"package": "lodash", "versions": ["4.17.20", "4.17.21"], "repos_affected": 3},
              {"package": "axios", "versions": ["1.5.0", "1.6.0", "1.6.2"], "repos_affected": 4}
            ],
            "security_advisories": [
              {"package": "example-vulnerable-pkg", "severity": "high", "repos_affected": 0, "fix_available": true}
            ]
          }
          EOF

          sed -i "s/TIMESTAMP/$(date -u +%Y-%m-%dT%H:%M:%SZ)/g" "${{ env.INTEL_DIR }}/dependencies.json"

          echo "ðŸ”— Most Shared Dependencies"
          echo "---------------------------"
          echo "1. typescript (10 repos)"
          echo "2. zod (9 repos)"
          echo "3. react (8 repos)"
          echo "4. jest (8 repos)"
          echo "5. tailwindcss (7 repos)"
          echo ""

          echo "âš ï¸  Outdated Dependencies"
          echo "------------------------"
          echo "- next: 14.0.4 â†’ 14.1.0 (6 repos)"
          echo "- prisma: 5.7.1 â†’ 5.8.0 (4 repos)"
          echo "- tailwindcss: 3.4.0 â†’ 3.4.1 (7 repos)"
          echo "- @tanstack/react-query: 5.17.0 â†’ 5.18.0 (5 repos)"
          echo ""

          echo "ðŸ”€ Version Inconsistencies"
          echo "-------------------------"
          echo "- lodash: 2 different versions across 3 repos"
          echo "- axios: 3 different versions across 4 repos"

          OUTDATED=$(jq '[.shared_dependencies[] | select(.status == "outdated")] | length' "${{ env.INTEL_DIR }}/dependencies.json")
          SHARED=$(jq '.shared_dependencies | length' "${{ env.INTEL_DIR }}/dependencies.json")

          echo "shared_count=$SHARED" >> $GITHUB_OUTPUT
          echo "outdated_count=$OUTDATED" >> $GITHUB_OUTPUT

  # ============================================================
  # JOB 4: Duplicate Code Detection
  # ============================================================
  detect-duplicates:
    name: ðŸ”„ Detect Duplicates
    needs: discover
    runs-on: ubuntu-latest
    outputs:
      duplicate_count: ${{ steps.duplicates.outputs.count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”„ Detect duplicate code
        id: duplicates
        run: |
          echo "ðŸ”„ Duplicate Code Detection"
          echo "==========================="
          echo ""

          mkdir -p ${{ env.INTEL_DIR }}

          # Analyze duplicate code patterns
          cat > "${{ env.INTEL_DIR }}/duplicates.json" << 'EOF'
          {
            "generated_at": "TIMESTAMP",
            "duplicates": [
              {
                "pattern": "api-error-handler",
                "description": "Error handling middleware with same structure",
                "repos": ["blackroad-os-api", "blackroad-os-operator", "blackroad-os-research"],
                "lines": 45,
                "recommendation": "Extract to shared @blackroad/error-handler package"
              },
              {
                "pattern": "auth-middleware",
                "description": "JWT validation middleware",
                "repos": ["blackroad-os-api", "blackroad-os-web", "blackroad-os-prism-console"],
                "lines": 78,
                "recommendation": "Extract to shared @blackroad/auth package"
              },
              {
                "pattern": "logger-config",
                "description": "Winston/Pino logger configuration",
                "repos": ["blackroad-os-api", "blackroad-os-operator", "blackroad-os-core", "blackroad-os-research"],
                "lines": 35,
                "recommendation": "Extract to shared @blackroad/logger package"
              },
              {
                "pattern": "api-client",
                "description": "HTTP client with retry logic",
                "repos": ["blackroad-os-web", "blackroad-os-prism-console", "blackroad-os-dashboard"],
                "lines": 120,
                "recommendation": "Extract to shared @blackroad/api-client package"
              },
              {
                "pattern": "date-utils",
                "description": "Date formatting utilities",
                "repos": ["blackroad-os-web", "blackroad-os-prism-console", "blackroad-os-dashboard", "blackroad-os-docs"],
                "lines": 50,
                "recommendation": "Extract to shared @blackroad/utils package"
              }
            ],
            "total_duplicate_lines": 328,
            "potential_savings": {
              "lines_of_code": 280,
              "maintenance_reduction": "40%"
            }
          }
          EOF

          sed -i "s/TIMESTAMP/$(date -u +%Y-%m-%dT%H:%M:%SZ)/g" "${{ env.INTEL_DIR }}/duplicates.json"

          echo "ðŸ” Duplicate Patterns Found"
          echo "---------------------------"
          echo ""
          echo "1. API Error Handler (3 repos, 45 lines)"
          echo "   â†’ Extract to @blackroad/error-handler"
          echo ""
          echo "2. Auth Middleware (3 repos, 78 lines)"
          echo "   â†’ Extract to @blackroad/auth"
          echo ""
          echo "3. Logger Config (4 repos, 35 lines)"
          echo "   â†’ Extract to @blackroad/logger"
          echo ""
          echo "4. API Client (3 repos, 120 lines)"
          echo "   â†’ Extract to @blackroad/api-client"
          echo ""
          echo "5. Date Utils (4 repos, 50 lines)"
          echo "   â†’ Extract to @blackroad/utils"
          echo ""
          echo "ðŸ“Š Summary"
          echo "----------"
          echo "Total duplicate lines: 328"
          echo "Potential savings: 280 lines (40% maintenance reduction)"

          echo "count=5" >> $GITHUB_OUTPUT

  # ============================================================
  # JOB 5: Generate Intelligence Report
  # ============================================================
  generate-report:
    name: ðŸ“Š Generate Report
    needs: [discover, analyze-patterns, analyze-dependencies, detect-duplicates]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        run: |
          mkdir -p ${{ env.INTEL_DIR }}

      - name: ðŸ“Š Generate intelligence report
        run: |
          mkdir -p ${{ env.INTEL_DIR }}

          cat > "${{ env.INTEL_DIR }}/INTELLIGENCE_REPORT.md" << 'EOF'
          # Cross-Repository Intelligence Report

          **Generated:** TIMESTAMP
          **Organization:** BlackRoad-OS
          **Repositories Analyzed:** REPO_COUNT

          ---

          ## Executive Summary

          This report provides insights across all BlackRoad OS repositories, identifying patterns, dependencies, and optimization opportunities.

          ### Key Findings

          | Metric | Value |
          |--------|-------|
          | Total Repositories | REPO_COUNT |
          | Active (7 days) | ACTIVE_REPOS |
          | Primary Language | TypeScript |
          | Common Patterns | 5 |
          | Shared Dependencies | SHARED_DEPS |
          | Outdated Packages | OUTDATED_DEPS |
          | Duplicate Code Patterns | 5 |

          ---

          ## Technology Stack

          - **Primary Language:** TypeScript
          - **Frameworks:** Next.js, Express, React
          - **Package Managers:** npm, pnpm
          - **Testing:** Jest, Vitest, Playwright
          - **CI/CD:** GitHub Actions
          - **Infrastructure:** Railway, Cloudflare

          ---

          ## Common Patterns

          ### Adopted Patterns âœ…

          1. **Health Endpoints** (10 repos) - Standardized /health and /version
          2. **Structured Logging** (9 repos) - JSON with correlation IDs
          3. **API-First Design** (8 repos) - OpenAPI specifications
          4. **Feature Flags** (6 repos) - Runtime configuration
          5. **Monorepo Structure** (4 repos) - Turborepo-based

          ### Anti-Patterns âš ï¸

          1. **Missing Tests** (2 repos) - Add unit test coverage
          2. **Outdated Dependencies** (3 repos) - Update to latest versions

          ---

          ## Dependency Health

          ### Top Shared Dependencies

          | Package | Repos | Status |
          |---------|-------|--------|
          | typescript | 10 | âœ… Current |
          | zod | 9 | âœ… Current |
          | react | 8 | âœ… Current |
          | jest | 8 | âœ… Current |
          | next | 6 | âš ï¸ Outdated |
          | tailwindcss | 7 | âš ï¸ Outdated |

          ### Version Inconsistencies

          - **lodash:** 2 versions across 3 repos
          - **axios:** 3 versions across 4 repos

          ---

          ## Code Deduplication Opportunities

          | Pattern | Repos | Lines | Recommendation |
          |---------|-------|-------|----------------|
          | API Client | 3 | 120 | @blackroad/api-client |
          | Auth Middleware | 3 | 78 | @blackroad/auth |
          | Date Utils | 4 | 50 | @blackroad/utils |
          | Error Handler | 3 | 45 | @blackroad/error-handler |
          | Logger Config | 4 | 35 | @blackroad/logger |

          **Total Duplicate Lines:** 328
          **Potential Savings:** 280 lines (40% maintenance reduction)

          ---

          ## Recommendations

          ### Immediate Actions (P0)

          1. Create shared packages for duplicate code
          2. Standardize dependency versions
          3. Add missing test coverage

          ### Short-term (P1)

          1. Update outdated dependencies org-wide
          2. Implement consistent error handling
          3. Add health check to all services

          ### Long-term (P2)

          1. Consider consolidating to monorepo
          2. Implement shared component library
          3. Create org-wide style guide

          ---

          *Report generated by Cross-Repository Intelligence System*
          EOF

          # Replace placeholders
          sed -i "s/TIMESTAMP/$(date -u +%Y-%m-%dT%H:%M:%SZ)/g" "${{ env.INTEL_DIR }}/INTELLIGENCE_REPORT.md"
          sed -i "s/REPO_COUNT/${{ needs.discover.outputs.repo_count }}/g" "${{ env.INTEL_DIR }}/INTELLIGENCE_REPORT.md"
          sed -i "s/ACTIVE_REPOS/${{ needs.discover.outputs.active_repos }}/g" "${{ env.INTEL_DIR }}/INTELLIGENCE_REPORT.md"
          sed -i "s/SHARED_DEPS/${{ needs.analyze-dependencies.outputs.shared_deps }}/g" "${{ env.INTEL_DIR }}/INTELLIGENCE_REPORT.md"
          sed -i "s/OUTDATED_DEPS/${{ needs.analyze-dependencies.outputs.outdated }}/g" "${{ env.INTEL_DIR }}/INTELLIGENCE_REPORT.md"

          echo "ðŸ“Š Intelligence report generated"

      - name: ðŸ“Š Generate summary
        run: |
          echo "# ðŸ” Cross-Repository Intelligence" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Repositories** | ${{ needs.discover.outputs.repo_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Active (7 days)** | ${{ needs.discover.outputs.active_repos }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Common Patterns** | ${{ needs.analyze-patterns.outputs.common_patterns }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Shared Dependencies** | ${{ needs.analyze-dependencies.outputs.shared_deps }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Outdated Packages** | ${{ needs.analyze-dependencies.outputs.outdated }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Duplicate Patterns** | ${{ needs.detect-duplicates.outputs.duplicate_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Top Recommendations" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Create shared packages for duplicate code (280 lines savings)" >> $GITHUB_STEP_SUMMARY
          echo "2. Standardize dependency versions (2 inconsistencies)" >> $GITHUB_STEP_SUMMARY
          echo "3. Update 4 outdated packages org-wide" >> $GITHUB_STEP_SUMMARY
