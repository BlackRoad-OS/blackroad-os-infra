name: Sync Infrastructure to All Repos

on:
  push:
    branches: [main]
    paths:
      - 'templates/**'
      - '.github/workflows/templates/**'
  workflow_dispatch:
    inputs:
      target:
        description: 'Target repos (comma-separated or "all")'
        required: true
        default: 'all'
        type: string
      files:
        description: 'Files to sync (comma-separated)'
        required: true
        default: 'railway.toml,Dockerfile,.github/workflows/deploy.yml'
        type: string

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  sync:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        repo:
          - blackroad-os
          - blackroad-os-api
          - blackroad-os-api-gateway
          - blackroad-os-agents
          - blackroad-os-archive
          - blackroad-os-beacon
          - blackroad-os-brand
          - blackroad-os-core
          - blackroad-os-demo
          - blackroad-os-docs
          - blackroad-os-home
          - blackroad-os-ideas
          - blackroad-os-master
          - blackroad-os-operator
          - blackroad-os-pack-creator-studio
          - blackroad-os-pack-education
          - blackroad-os-pack-finance
          - blackroad-os-pack-infra-devops
          - blackroad-os-pack-legal
          - blackroad-os-pack-research-lab
          - blackroad-os-prism-console
          - blackroad-os-research
          - blackroad-os-web
    steps:
      - name: Checkout infra repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Checkout target repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          repository: BlackRoad-OS/${{ matrix.repo }}
          path: target
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Sync files
        run: |
          echo "Syncing to ${{ matrix.repo }}..."

          # Sync railway.toml if exists in templates
          if [ -f "templates/railway.toml" ]; then
            cp templates/railway.toml target/railway.toml
            echo "  ‚úì railway.toml"
          fi

          # Sync Dockerfile if exists in templates
          if [ -f "templates/Dockerfile" ]; then
            cp templates/Dockerfile target/Dockerfile
            echo "  ‚úì Dockerfile"
          fi

          # Sync deploy workflow
          mkdir -p target/.github/workflows
          if [ -f "templates/deploy.yml" ]; then
            cp templates/deploy.yml target/.github/workflows/deploy.yml
            echo "  ‚úì .github/workflows/deploy.yml"
          fi

      - name: Commit and push
        working-directory: target
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "chore(infra): sync infrastructure from blackroad-os-infra

          Automated sync of infrastructure configuration.

          ü§ñ Generated by GitHub Actions"
            git push
            echo "‚úÖ ${{ matrix.repo }} updated"
          else
            echo "‚è≠Ô∏è  ${{ matrix.repo }} already up to date"
          fi
