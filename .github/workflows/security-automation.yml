name: ðŸ›¡ï¸ Security Automation Suite

on:
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

permissions:
  contents: write
  security-events: write
  issues: write

jobs:
  dependency-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: ðŸ” Run npm audit
        id: audit
        run: |
          npm audit --audit-level=moderate --json > audit-results.json || true

          VULNERABILITIES=$(jq '.metadata.vulnerabilities.total' audit-results.json)
          echo "vulnerabilities=$VULNERABILITIES" >> $GITHUB_OUTPUT

          if [ "$VULNERABILITIES" -gt 0 ]; then
            echo "âš ï¸  Found $VULNERABILITIES vulnerabilities"
          fi

      - name: ðŸ”§ Auto-fix vulnerabilities
        if: steps.audit.outputs.vulnerabilities > 0
        run: |
          echo "Auto-fixing vulnerabilities..."
          npm audit fix --force || true

          if ! git diff --quiet package*.json; then
            git config user.name "BlackRoad Security Bot"
            git config user.email "security@blackroad.systems"
            git add package*.json
            git commit -m "security: Auto-fix dependency vulnerabilities

Fixed ${{ steps.audit.outputs.vulnerabilities }} vulnerabilities

ðŸ›¡ï¸ Auto-patched by Security Automation Suite"
            git push
          fi

  secret-scanning:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0

      - name: ðŸ” Scan for secrets
        run: |
          echo "Scanning for exposed secrets..."

          # Common secret patterns
          PATTERNS=(
            "api[_-]?key"
            "api[_-]?secret"
            "password"
            "token"
            "secret[_-]?key"
            "private[_-]?key"
            "aws[_-]?access"
            "aws[_-]?secret"
          )

          FOUND=false

          for pattern in "${PATTERNS[@]}"; do
            if grep -rni "$pattern" --include="*.js" --include="*.ts" --include="*.env" --exclude-dir=node_modules . 2>/dev/null | \
               grep -v "\.example" | grep -v "//.*$pattern"; then
              echo "âš ï¸  Potential secret found: $pattern"
              FOUND=true
            fi
          done

          if [ "$FOUND" = true ]; then
            echo "âŒ Secrets detected! Review required."
            exit 1
          else
            echo "âœ… No secrets detected"
          fi

  codeql-analysis:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: ðŸ” Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, typescript

      - name: ðŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: ðŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  compliance-check:
    name: Compliance & License Check
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: ðŸ“œ Check licenses
        run: |
          echo "Checking dependency licenses..."

          npm install -g license-checker

          license-checker --json > licenses.json || true

          # Check for GPL licenses (copyleft)
          if jq -r '.[] | select(.licenses | contains("GPL"))' licenses.json | grep -q "GPL"; then
            echo "âš ï¸  GPL license detected - review required"
          fi

          echo "âœ… License check complete"

  security-scorecard:
    name: Generate Security Scorecard
    runs-on: ubuntu-latest
    needs: [dependency-audit, secret-scanning, codeql-analysis, compliance-check]
    if: always()
    steps:
      - name: ðŸ“Š Generate security scorecard
        run: |
          echo "# ðŸ›¡ï¸ Security Automation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Security Checks" >> $GITHUB_STEP_SUMMARY
          echo "- **Dependency Audit:** ${{ needs.dependency-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Secret Scanning:** ${{ needs.secret-scanning.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **CodeQL Analysis:** ${{ needs.codeql-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Compliance Check:** ${{ needs.compliance-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Overall Security Score" >> $GITHUB_STEP_SUMMARY

          PASSED=0
          [ "${{ needs.dependency-audit.result }}" = "success" ] && PASSED=$((PASSED + 1))
          [ "${{ needs.secret-scanning.result }}" = "success" ] && PASSED=$((PASSED + 1))
          [ "${{ needs.codeql-analysis.result }}" = "success" ] && PASSED=$((PASSED + 1))
          [ "${{ needs.compliance-check.result }}" = "success" ] && PASSED=$((PASSED + 1))

          SCORE=$((PASSED * 25))

          echo "**Score:** $SCORE/100" >> $GITHUB_STEP_SUMMARY

          if [ $SCORE -ge 75 ]; then
            echo "**Status:** âœ… Good" >> $GITHUB_STEP_SUMMARY
          elif [ $SCORE -ge 50 ]; then
            echo "**Status:** âš ï¸  Needs Attention" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** âŒ Critical" >> $GITHUB_STEP_SUMMARY
          fi
