name: Deploy to DigitalOcean Droplet

on:
  push:
    branches: [main, master]
    paths:
      - 'droplet-services/**'
      - 'docker-compose.yaml'
      - 'Dockerfile'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Deploy to Droplet via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: root
          key: ${{ secrets.DROPLET_SSH_KEY }}
          script: |
            echo "üöÄ Deploying to DigitalOcean Droplet..."

            # Navigate to application directory
            cd /opt/blackroad || exit 1

            # Pull latest code
            echo "üì• Pulling latest code..."
            git fetch origin
            git reset --hard origin/main

            # Backup current state
            echo "üíæ Creating backup..."
            docker-compose down
            tar -czf backup_$(date +%Y%m%d_%H%M%S).tar.gz . || true

            # Pull new images
            echo "üì¶ Pulling Docker images..."
            docker-compose pull

            # Build and restart services
            echo "üî® Building and starting services..."
            docker-compose up -d --build

            # Wait for services to start
            echo "‚è≥ Waiting for services..."
            sleep 15

            # Health check
            echo "üè• Running health checks..."
            docker-compose ps

            # Test services
            curl -f http://localhost:8000/health || echo "‚ö†Ô∏è Health check failed"

            echo "‚úÖ Deployment complete!"

      - name: Verify Deployment
        run: |
          echo "üîç Verifying deployment..."
          curl -I https://codex.blackroad.io/health || echo "‚ö†Ô∏è External health check failed"

      - name: Notify on Success
        if: success()
        run: |
          echo "‚úÖ Droplet deployment successful!"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "‚ùå Droplet deployment failed!"
