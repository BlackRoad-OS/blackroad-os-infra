name: terraform-plan

on:
  pull_request:
    paths:
      - 'terraform/**'
      - 'modules/**'
      - '.github/workflows/**'
      - 'scripts/**'
      - 'docs/**'
      - 'README.md'

permissions:
  contents: read
  pull-requests: write

jobs:
  plan:
    runs-on: ubuntu-latest
    env:
      TF_IN_AUTOMATION: "true"
      WORKING_DIR: terraform/environments/dev
    steps:
      - name: Checkout
        uses: actions/checkout@f43a3398dc5d8737c2dbc7bf8ad6b50918d7a3d4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: 1.8.5

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@19a52fbac37dacb22a09518e4ef6ee234f2d4987 # v4.0.0
        with:
          tflint_version: latest

      - name: Setup tfsec
        uses: aquasecurity/setup-tfsec@v1

      - name: Setup Python
        uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d # v5.1.0
        with:
          python-version: '3.x'

      - name: Install checkov
        run: pip install checkov

      - name: Lint and format
        run: bash scripts/fmt.sh

      - name: Terraform init (local backend for plan)
        run: terraform init -backend=false
        working-directory: ${{ env.WORKING_DIR }}

      - name: Terraform plan
        run: terraform plan -var-file=terraform.tfvars -no-color | tee plan.out
        working-directory: ${{ env.WORKING_DIR }}

      - name: Comment plan on PR
        if: github.event.pull_request.number != ''
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('${{ env.WORKING_DIR }}/plan.out', 'utf8');
            const body = `### Terraform Plan (dev)\n\n\n\u0060\u0060\u0060\n${plan}\n\u0060\u0060\u0060\n\n_Label: terraform-plan_`;
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body,
            });
