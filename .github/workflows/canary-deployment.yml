name: ðŸ¦ Canary Deployment System

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy'
        required: true
        type: string
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production
      image_tag:
        description: 'Docker image tag to deploy'
        required: true
        type: string
      canary_percentage:
        description: 'Initial canary percentage'
        required: false
        default: '5'
        type: choice
        options:
          - '5'
          - '10'
          - '25'
      auto_promote:
        description: 'Auto-promote on success'
        required: false
        default: true
        type: boolean
  repository_dispatch:
    types: [canary-deploy]

permissions:
  contents: write
  issues: write
  actions: write
  pull-requests: write
  deployments: write

env:
  HEALTH_CHECK_RETRIES: 3

jobs:
  # ============================================================
  # STAGE 1: Pre-Deployment Validation
  # ============================================================
  validate-deployment:
    name: ðŸ” Validate Deployment Request
    runs-on: ubuntu-latest
    outputs:
      service: ${{ steps.validate.outputs.service }}
      environment: ${{ steps.validate.outputs.environment }}
      image_tag: ${{ steps.validate.outputs.image_tag }}
      canary_start: ${{ steps.validate.outputs.canary_start }}
      deployment_id: ${{ steps.validate.outputs.deployment_id }}
      can_proceed: ${{ steps.validate.outputs.can_proceed }}
      start_time: ${{ steps.validate.outputs.start_time }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ” Validate deployment parameters
        id: validate
        run: |
          SERVICE="${{ github.event.inputs.service || github.event.client_payload.service }}"
          ENVIRONMENT="${{ github.event.inputs.environment || github.event.client_payload.environment }}"
          IMAGE_TAG="${{ github.event.inputs.image_tag || github.event.client_payload.image_tag }}"
          CANARY_START="${{ github.event.inputs.canary_percentage || github.event.client_payload.canary_percentage || '5' }}"

          DEPLOYMENT_ID="canary-$(date +%Y%m%d-%H%M%S)-${GITHUB_RUN_NUMBER}"

          echo "ðŸ¦ Canary Deployment Validation"
          echo "================================"
          echo "Service: $SERVICE"
          echo "Environment: $ENVIRONMENT"
          echo "Image Tag: $IMAGE_TAG"
          echo "Initial Canary: ${CANARY_START}%"
          echo "Deployment ID: $DEPLOYMENT_ID"
          echo ""

          CAN_PROCEED="true"
          ERRORS=""

          # Validate service exists
          if [ -z "$SERVICE" ]; then
            ERRORS="${ERRORS}âŒ Service name is required\n"
            CAN_PROCEED="false"
          fi

          # Validate environment
          if [ "$ENVIRONMENT" != "staging" ] && [ "$ENVIRONMENT" != "production" ]; then
            ERRORS="${ERRORS}âŒ Environment must be 'staging' or 'production'\n"
            CAN_PROCEED="false"
          fi

          # Validate image tag
          if [ -z "$IMAGE_TAG" ]; then
            ERRORS="${ERRORS}âŒ Image tag is required\n"
            CAN_PROCEED="false"
          fi

          # Check for existing canary deployments
          if [ -f .github/canary-state.json ]; then
            EXISTING_CANARY=$(jq -r ".active_canaries.\"$SERVICE\"" .github/canary-state.json 2>/dev/null || echo "null")
          else
            EXISTING_CANARY="null"
          fi
          if [ "$EXISTING_CANARY" != "null" ] && [ -n "$EXISTING_CANARY" ]; then
            echo "âš ï¸  Warning: Existing canary deployment detected for $SERVICE"
            echo "   Previous deployment: $EXISTING_CANARY"
            echo "   This will replace the existing canary"
          fi

          # Production deployment window check (delegated to shared script)
          bash .github/scripts/check-production-deployment-window.sh "$ENVIRONMENT"

          if [ "$CAN_PROCEED" = "false" ]; then
            echo ""
            echo "Validation Errors:"
            echo -e "$ERRORS"
            exit 1
          fi

          echo "âœ… Validation passed"

          START_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          echo "service=$SERVICE" >> $GITHUB_OUTPUT
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "canary_start=$CANARY_START" >> $GITHUB_OUTPUT
          echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          echo "can_proceed=$CAN_PROCEED" >> $GITHUB_OUTPUT
          echo "start_time=$START_TIME" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Check service health baseline
        id: baseline
        run: |
          SERVICE="${{ steps.validate.outputs.service }}"
          ENVIRONMENT="${{ steps.validate.outputs.environment }}"

          echo "ðŸ“Š Capturing baseline metrics for $SERVICE"

          # Create baseline metrics snapshot
          cat > /tmp/baseline-metrics.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "service": "$SERVICE",
            "environment": "$ENVIRONMENT",
            "metrics": {
              "error_rate": 0.5,
              "latency_p50": 45,
              "latency_p95": 120,
              "latency_p99": 250,
              "success_rate": 99.5,
              "requests_per_second": 1250
            }
          }
          EOF

          cat /tmp/baseline-metrics.json

          # Store baseline for comparison
          mkdir -p .github/canary-baselines
          cp /tmp/baseline-metrics.json ".github/canary-baselines/${SERVICE}-baseline.json"

      - name: ðŸ”” Notify deployment start
        run: |
          DEPLOYMENT_ID="${{ steps.validate.outputs.deployment_id }}"
          SERVICE="${{ steps.validate.outputs.service }}"
          ENVIRONMENT="${{ steps.validate.outputs.environment }}"
          IMAGE_TAG="${{ steps.validate.outputs.image_tag }}"

          echo "ðŸ”” Deployment Notification"
          echo "=========================="
          echo ""
          echo "ðŸ¦ Canary Deployment Started"
          echo ""
          echo "ðŸ“‹ Details:"
          echo "  â€¢ Deployment ID: $DEPLOYMENT_ID"
          echo "  â€¢ Service: $SERVICE"
          echo "  â€¢ Environment: $ENVIRONMENT"
          echo "  â€¢ Image: $IMAGE_TAG"
          echo "  â€¢ Initial Traffic: ${{ steps.validate.outputs.canary_start }}%"
          echo "  â€¢ Initiated by: ${{ github.actor }}"
          echo ""
          echo "ðŸ“ˆ Progression: 5% â†’ 25% â†’ 50% â†’ 100%"
          echo "â±ï¸  Health checks every 30 seconds"

  # ============================================================
  # STAGE 2: Deploy Canary (Initial 5%)
  # ============================================================
  deploy-canary-5:
    name: ðŸ¦ Deploy Canary (5%)
    needs: validate-deployment
    runs-on: ubuntu-latest
    outputs:
      health_status: ${{ steps.health.outputs.status }}
      can_promote: ${{ steps.health.outputs.can_promote }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: ðŸš€ Deploy canary instance (5% traffic)
        id: deploy
        run: |
          SERVICE="${{ needs.validate-deployment.outputs.service }}"
          IMAGE_TAG="${{ needs.validate-deployment.outputs.image_tag }}"
          DEPLOYMENT_ID="${{ needs.validate-deployment.outputs.deployment_id }}"

          echo "ðŸš€ Deploying Canary (5% Traffic)"
          echo "================================"
          echo ""

          # Simulate canary deployment
          echo "ðŸ“¦ Pulling image: $SERVICE:$IMAGE_TAG"
          sleep 2

          echo "ðŸ”„ Starting canary instances..."
          sleep 2

          echo "ðŸŒ Configuring traffic split: 5% canary, 95% stable"
          sleep 1

          # Create deployment state
          mkdir -p .github/canary-state
          cat > ".github/canary-state/${SERVICE}.json" << EOF
          {
            "deployment_id": "$DEPLOYMENT_ID",
            "service": "$SERVICE",
            "image_tag": "$IMAGE_TAG",
            "stage": "canary-5",
            "traffic_percentage": 5,
            "started_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "status": "in_progress",
            "health_checks": []
          }
          EOF

          echo "âœ… Canary deployed with 5% traffic"
          echo "canary_deployed=true" >> $GITHUB_OUTPUT

      - name: â³ Wait for traffic stabilization
        run: |
          STABILIZATION_WAIT_SECONDS="${STABILIZATION_WAIT_SECONDS:-60}"
          echo "â³ Waiting ${STABILIZATION_WAIT_SECONDS} seconds for traffic stabilization..."
          sleep "${STABILIZATION_WAIT_SECONDS}"  # Default 60 seconds for production, configurable via env var
          echo "âœ… Traffic stabilized"

      - name: ðŸ¥ Health check - Round 1
        id: health1
        run: |
          SERVICE="${{ needs.validate-deployment.outputs.service }}"

          echo "ðŸ¥ Health Check Round 1/3"
          echo "========================="

          # Simulate health check
          HEALTH_SCORE=98
          ERROR_RATE=0.3
          LATENCY_P95=125

          echo "  âœ… Health Score: ${HEALTH_SCORE}%"
          echo "  âœ… Error Rate: ${ERROR_RATE}%"
          echo "  âœ… P95 Latency: ${LATENCY_P95}ms"

          echo "health_score=$HEALTH_SCORE" >> $GITHUB_OUTPUT

      - name: ðŸ¥ Health check - Round 2
        id: health2
        run: |
          echo "ðŸ¥ Health Check Round 2/3"
          echo "========================="
          sleep 5

          HEALTH_SCORE=97
          ERROR_RATE=0.4
          LATENCY_P95=128

          echo "  âœ… Health Score: ${HEALTH_SCORE}%"
          echo "  âœ… Error Rate: ${ERROR_RATE}%"
          echo "  âœ… P95 Latency: ${LATENCY_P95}ms"

          echo "health_score=$HEALTH_SCORE" >> $GITHUB_OUTPUT

      - name: ðŸ¥ Health check - Round 3
        id: health3
        run: |
          echo "ðŸ¥ Health Check Round 3/3"
          echo "========================="
          sleep 5

          HEALTH_SCORE=98
          ERROR_RATE=0.35
          LATENCY_P95=122

          echo "  âœ… Health Score: ${HEALTH_SCORE}%"
          echo "  âœ… Error Rate: ${ERROR_RATE}%"
          echo "  âœ… P95 Latency: ${LATENCY_P95}ms"

          echo "health_score=$HEALTH_SCORE" >> $GITHUB_OUTPUT

      - name: ðŸ“Š Analyze health results
        id: health
        run: |
          H1=${{ steps.health1.outputs.health_score }}
          H2=${{ steps.health2.outputs.health_score }}
          H3=${{ steps.health3.outputs.health_score }}

          AVG_HEALTH=$(( (H1 + H2 + H3) / 3 ))

          echo ""
          echo "ðŸ“Š Health Analysis Summary"
          echo "=========================="
          echo "  Round 1: ${H1}%"
          echo "  Round 2: ${H2}%"
          echo "  Round 3: ${H3}%"
          echo "  Average: ${AVG_HEALTH}%"
          echo ""

          if [ "$AVG_HEALTH" -ge 95 ]; then
            echo "âœ… HEALTHY - Ready to promote to 25%"
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "can_promote=true" >> $GITHUB_OUTPUT
          elif [ "$AVG_HEALTH" -ge 85 ]; then
            echo "âš ï¸  DEGRADED - Monitoring closely"
            echo "status=degraded" >> $GITHUB_OUTPUT
            echo "can_promote=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ UNHEALTHY - Triggering rollback"
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            echo "can_promote=false" >> $GITHUB_OUTPUT
          fi

  # ============================================================
  # STAGE 3: Promote to 25%
  # ============================================================
  deploy-canary-25:
    name: ðŸ¦ Promote Canary (25%)
    needs: [validate-deployment, deploy-canary-5]
    if: needs.deploy-canary-5.outputs.can_promote == 'true'
    runs-on: ubuntu-latest
    outputs:
      health_status: ${{ steps.health.outputs.status }}
      can_promote: ${{ steps.health.outputs.can_promote }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: ðŸš€ Promote to 25% traffic
        run: |
          SERVICE="${{ needs.validate-deployment.outputs.service }}"

          echo "ðŸš€ Promoting Canary to 25% Traffic"
          echo "=================================="
          echo ""
          echo "ðŸ”„ Adjusting traffic split: 25% canary, 75% stable"
          sleep 2

          echo "âœ… Traffic promoted to 25%"

      - name: â³ Wait for traffic stabilization
        run: |
          echo "â³ Waiting for traffic stabilization..."
          sleep 10
          echo "âœ… Traffic stabilized at 25%"

      - name: ðŸ¥ Run health checks
        id: health
        run: |
          echo "ðŸ¥ Health Checks at 25% Traffic"
          echo "==============================="

          CHECKS_PASSED=0
          TOTAL_CHECKS=3

          for i in 1 2 3; do
            echo ""
            echo "Check $i/$TOTAL_CHECKS..."
            sleep 3

            # Simulate health check
            HEALTH_SCORE=$((95 + RANDOM % 5))
            ERROR_RATE="0.$((RANDOM % 5))"
            LATENCY=$((100 + RANDOM % 50))

            echo "  âœ… Health: ${HEALTH_SCORE}% | Errors: ${ERROR_RATE}% | P95: ${LATENCY}ms"

            if [ "$HEALTH_SCORE" -ge 90 ]; then
              CHECKS_PASSED=$((CHECKS_PASSED + 1))
            fi
          done

          echo ""
          echo "ðŸ“Š Summary: $CHECKS_PASSED/$TOTAL_CHECKS checks passed"

          if [ "$CHECKS_PASSED" -ge 2 ]; then
            echo "âœ… Health threshold met - Ready for 50%"
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "can_promote=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Health threshold not met - Initiating rollback"
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            echo "can_promote=false" >> $GITHUB_OUTPUT
          fi

  # ============================================================
  # STAGE 4: Promote to 50%
  # ============================================================
  deploy-canary-50:
    name: ðŸ¦ Promote Canary (50%)
    needs: [validate-deployment, deploy-canary-25]
    if: needs.deploy-canary-25.outputs.can_promote == 'true'
    runs-on: ubuntu-latest
    outputs:
      health_status: ${{ steps.health.outputs.status }}
      can_promote: ${{ steps.health.outputs.can_promote }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: ðŸš€ Promote to 50% traffic
        run: |
          SERVICE="${{ needs.validate-deployment.outputs.service }}"

          echo "ðŸš€ Promoting Canary to 50% Traffic"
          echo "=================================="
          echo ""
          echo "ðŸ”„ Adjusting traffic split: 50% canary, 50% stable"
          sleep 2

          echo "âœ… Traffic promoted to 50%"

      - name: â³ Extended stabilization period
        run: |
          echo "â³ Extended stabilization period (50% is critical threshold)..."
          sleep 15
          echo "âœ… Traffic stabilized at 50%"

      - name: ðŸ¥ Run comprehensive health checks
        id: health
        run: |
          echo "ðŸ¥ Comprehensive Health Checks at 50% Traffic"
          echo "============================================="

          CHECKS_PASSED=0
          TOTAL_CHECKS=5

          for i in 1 2 3 4 5; do
            echo ""
            echo "Check $i/$TOTAL_CHECKS..."
            sleep 3

            HEALTH_SCORE=$((94 + RANDOM % 6))
            ERROR_RATE="0.$((RANDOM % 6))"
            LATENCY=$((110 + RANDOM % 40))

            echo "  âœ… Health: ${HEALTH_SCORE}% | Errors: ${ERROR_RATE}% | P95: ${LATENCY}ms"

            if [ "$HEALTH_SCORE" -ge 90 ]; then
              CHECKS_PASSED=$((CHECKS_PASSED + 1))
            fi
          done

          echo ""
          echo "ðŸ“Š Summary: $CHECKS_PASSED/$TOTAL_CHECKS checks passed"

          if [ "$CHECKS_PASSED" -ge 4 ]; then
            echo "âœ… Health threshold met - Ready for full promotion"
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "can_promote=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Health threshold not met"
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            echo "can_promote=false" >> $GITHUB_OUTPUT
          fi

  # ============================================================
  # STAGE 5: Full Promotion (100%)
  # ============================================================
  deploy-full:
    name: ðŸš€ Full Deployment (100%)
    needs: [validate-deployment, deploy-canary-50]
    if: needs.deploy-canary-50.outputs.can_promote == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: ðŸš€ Promote to 100% traffic
        run: |
          SERVICE="${{ needs.validate-deployment.outputs.service }}"
          IMAGE_TAG="${{ needs.validate-deployment.outputs.image_tag }}"
          DEPLOYMENT_ID="${{ needs.validate-deployment.outputs.deployment_id }}"

          echo "ðŸš€ Full Deployment - 100% Traffic"
          echo "================================="
          echo ""
          echo "ðŸ”„ Routing all traffic to new version..."
          sleep 2

          echo "ðŸ§¹ Decommissioning old instances..."
          sleep 2

          echo ""
          echo "âœ… Full deployment complete!"
          echo ""
          echo "ðŸ“‹ Deployment Summary:"
          echo "  â€¢ Deployment ID: $DEPLOYMENT_ID"
          echo "  â€¢ Service: $SERVICE"
          echo "  â€¢ Version: $IMAGE_TAG"
          echo "  â€¢ Traffic: 100%"
          echo "  â€¢ Duration: ~5 minutes"
          echo "  â€¢ Status: SUCCESS"

      - name: ðŸ¥ Final health verification
        run: |
          echo "ðŸ¥ Final Health Verification"
          echo "============================"
          sleep 5

          echo ""
          echo "âœ… All health checks passing"
          echo "âœ… Error rate: 0.2%"
          echo "âœ… P95 latency: 115ms"
          echo "âœ… Success rate: 99.8%"

      - name: ðŸ“ Update deployment record
        run: |
          SERVICE="${{ needs.validate-deployment.outputs.service }}"
          IMAGE_TAG="${{ needs.validate-deployment.outputs.image_tag }}"
          DEPLOYMENT_ID="${{ needs.validate-deployment.outputs.deployment_id }}"

          mkdir -p .github/deployment-history

          START_TIME="${{ needs.validate-deployment.outputs.start_time }}"
          COMPLETED_AT=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          # Calculate actual duration in seconds
          START_EPOCH=$(date -u -d "$START_TIME" +%s)
          COMPLETED_EPOCH=$(date -u +%s)
          DURATION_SECONDS=$((COMPLETED_EPOCH - START_EPOCH))

          cat > ".github/deployment-history/${DEPLOYMENT_ID}.json" << EOF
          {
            "deployment_id": "$DEPLOYMENT_ID",
            "service": "$SERVICE",
            "image_tag": "$IMAGE_TAG",
            "environment": "${{ needs.validate-deployment.outputs.environment }}",
            "type": "canary",
            "stages_completed": ["5%", "25%", "50%", "100%"],
            "started_at": "$START_TIME",
            "completed_at": "$COMPLETED_AT",
            "duration_seconds": $DURATION_SECONDS,
            "status": "success",
            "initiated_by": "${{ github.actor }}",
            "health_checks_passed": 14,
            "health_checks_total": 14,
            "rollbacks": 0
          }
          EOF

          echo "ðŸ“ Deployment record saved"

      - name: ðŸŽ‰ Notify success
        run: |
          echo ""
          echo "ðŸŽ‰ =================================="
          echo "   CANARY DEPLOYMENT SUCCESSFUL!"
          echo "ðŸŽ‰ =================================="
          echo ""
          echo "Service: ${{ needs.validate-deployment.outputs.service }}"
          echo "Version: ${{ needs.validate-deployment.outputs.image_tag }}"
          echo "Environment: ${{ needs.validate-deployment.outputs.environment }}"
          echo ""
          echo "Progression completed:"
          echo "  âœ… 5%  â†’ Healthy"
          echo "  âœ… 25% â†’ Healthy"
          echo "  âœ… 50% â†’ Healthy"
          echo "  âœ… 100% â†’ Deployed"
          echo ""
          echo "All health checks passed!"

  # ============================================================
  # ROLLBACK: Automatic rollback on failure
  # ============================================================
  rollback:
    name: ðŸ”™ Automatic Rollback
    needs: [validate-deployment, deploy-canary-5, deploy-canary-25, deploy-canary-50]
    if: |
      always() && (
        needs.deploy-canary-5.result == 'failure' ||
        needs.deploy-canary-25.result == 'failure' ||
        needs.deploy-canary-50.result == 'failure'
      )
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”™ Initiate rollback
        run: |
          SERVICE="${{ needs.validate-deployment.outputs.service }}"
          DEPLOYMENT_ID="${{ needs.validate-deployment.outputs.deployment_id }}"

          echo "ðŸ”™ Automatic Rollback Initiated"
          echo "==============================="
          echo ""
          echo "âš ï¸  Health checks failed - Rolling back to stable version"
          echo ""

          # Determine failed stage
          if [ "${{ needs.deploy-canary-5.outputs.can_promote }}" = "false" ]; then
            FAILED_STAGE="5%"
          elif [ "${{ needs.deploy-canary-25.outputs.can_promote }}" = "false" ]; then
            FAILED_STAGE="25%"
          else
            FAILED_STAGE="50%"
          fi

          echo "Failed at stage: $FAILED_STAGE"
          echo ""

          echo "ðŸ”„ Removing canary instances..."
          sleep 2

          echo "ðŸ”„ Restoring 100% traffic to stable version..."
          sleep 2

          echo ""
          echo "âœ… Rollback complete"
          echo ""
          echo "ðŸ“‹ Rollback Summary:"
          echo "  â€¢ Service: $SERVICE"
          echo "  â€¢ Deployment ID: $DEPLOYMENT_ID"
          echo "  â€¢ Failed Stage: $FAILED_STAGE"
          echo "  â€¢ Rollback Duration: ~4 seconds"
          echo "  â€¢ Stable Version: Restored"

      - name: ðŸ“ Record rollback
        run: |
          SERVICE="${{ needs.validate-deployment.outputs.service }}"
          DEPLOYMENT_ID="${{ needs.validate-deployment.outputs.deployment_id }}"

          mkdir -p .github/deployment-history

          START_TIME="${{ needs.validate-deployment.outputs.start_time }}"
          ROLLED_BACK_AT=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          cat > ".github/deployment-history/${DEPLOYMENT_ID}.json" << EOF
          {
            "deployment_id": "$DEPLOYMENT_ID",
            "service": "$SERVICE",
            "image_tag": "${{ needs.validate-deployment.outputs.image_tag }}",
            "environment": "${{ needs.validate-deployment.outputs.environment }}",
            "type": "canary",
            "status": "rolled_back",
            "started_at": "$START_TIME",
            "rolled_back_at": "$ROLLED_BACK_AT",
            "initiated_by": "${{ github.actor }}",
            "failure_reason": "health_check_failed"
          }
          EOF

      - name: ðŸš¨ Alert on rollback
        run: |
          echo ""
          echo "ðŸš¨ =================================="
          echo "   CANARY DEPLOYMENT ROLLED BACK"
          echo "ðŸš¨ =================================="
          echo ""
          echo "Service: ${{ needs.validate-deployment.outputs.service }}"
          echo "Version: ${{ needs.validate-deployment.outputs.image_tag }} (rolled back)"
          echo "Environment: ${{ needs.validate-deployment.outputs.environment }}"
          echo ""
          echo "Action required: Investigate health check failures"

  # ============================================================
  # SUMMARY: Generate deployment summary
  # ============================================================
  generate-summary:
    name: ðŸ“Š Generate Summary
    needs: [validate-deployment, deploy-canary-5, deploy-canary-25, deploy-canary-50, deploy-full]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“Š Generate deployment summary
        run: |
          echo "# ðŸ¦ Canary Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Service** | ${{ needs.validate-deployment.outputs.service }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | ${{ needs.validate-deployment.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Image Tag** | ${{ needs.validate-deployment.outputs.image_tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Deployment ID** | ${{ needs.validate-deployment.outputs.deployment_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Initiated By** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Stage Progression" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 5% Canary | ${{ needs.deploy-canary-5.outputs.health_status == 'healthy' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 25% Canary | ${{ needs.deploy-canary-25.outputs.health_status == 'healthy' && 'âœ… Passed' || (needs.deploy-canary-25.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 50% Canary | ${{ needs.deploy-canary-50.outputs.health_status == 'healthy' && 'âœ… Passed' || (needs.deploy-canary-50.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 100% Full | ${{ needs.deploy-full.result == 'success' && 'âœ… Deployed' || (needs.deploy-full.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed') }} |" >> $GITHUB_STEP_SUMMARY
