name: Gaia Truth Manifest Generator

on:
  # Run after key workflows complete (agent tasks, deployments)
  workflow_run:
    workflows:
      - "CI"
      - "Deploy"
      - "Agent Metrics"
    types:
      - completed

  # Allow manual trigger
  workflow_dispatch:

  # Run on schedule (daily at 00:00 UTC)
  schedule:
    - cron: '0 0 * * *'

jobs:
  generate-manifest:
    name: Generate and Commit Truth Manifest
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            cli/package-lock.json

      - name: Install CLI dependencies
        run: |
          cd cli
          npm ci

      - name: Generate Truth Manifest
        id: generate
        run: |
          cd cli
          npm run build

          # Generate manifest as JSON (without banner due to pipe)
          node dist/index.js gaia --manifest --json > ../manifests/truth-manifest-latest.json

          # Generate manifest as plain text for archive
          node dist/index.js gaia --manifest > ../truth-manifest.txt

          # Calculate root hash for commit message
          # Note: jq is pre-installed on ubuntu-latest runners
          ROOT_HASH=$(node dist/index.js gaia --manifest --json | jq -r '.rootHash')
          echo "root_hash=$ROOT_HASH" >> $GITHUB_OUTPUT

          echo "âœ“ Truth Manifest generated successfully"
          echo "Root Hash: $ROOT_HASH"

      - name: Create manifests directory
        run: mkdir -p manifests

      - name: Move manifests to directory
        run: |
          # Add timestamp to filename
          TIMESTAMP=$(date -u +"%Y-%m-%d_%H-%M-%S")

          # Copy current manifest JSON
          cp manifests/truth-manifest-latest.json "manifests/truth-manifest-${TIMESTAMP}.json"

          echo "âœ“ Manifests organized"

      - name: Commit and push manifests
        id: commit
        run: |
          git config --global user.name "Gaia Agent"
          git config --global user.email "gaia@blackroad.systems"

          git add manifests/truth-manifest-latest.json
          git add manifests/truth-manifest-*.json

          # Check if there are changes
          if git diff --cached --quiet; then
            echo "No changes to commit"
            echo "committed=false" >> $GITHUB_OUTPUT
          else
            git commit -m "ðŸ” Gaia: Update Truth Manifest (Root: ${{ steps.generate.outputs.root_hash }})"
            git push
            echo "committed=true" >> $GITHUB_OUTPUT
            echo "âœ“ Manifests committed and pushed"
          fi

      - name: Create summary
        if: steps.commit.outputs.committed == 'true'
        run: |
          echo "## ðŸ” Gaia Truth Manifest Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Root Hash:** \`${{ steps.generate.outputs.root_hash }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Components Verified" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat truth-manifest.txt >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ“ Mathematical certainty through cryptographic verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Any change to these components will trigger a PS-SHA-âˆž alert_" >> $GITHUB_STEP_SUMMARY
