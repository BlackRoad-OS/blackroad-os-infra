name: üîê Deployment Approval Gate

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy'
        required: true
        type: string
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production
      image_tag:
        description: 'Docker image tag'
        required: true
        type: string
      deployment_type:
        description: 'Deployment strategy'
        required: true
        type: choice
        options:
          - canary
          - blue-green
          - rolling
          - immediate
      requestor_notes:
        description: 'Deployment notes/reason'
        required: false
        type: string
  repository_dispatch:
    types: [request-deployment]

permissions:
  contents: write
  issues: write
  actions: write
  pull-requests: write
  deployments: write

env:
  # NOTE: APPROVAL_TIMEOUT_HOURS is informational; the actual approval timeout is enforced
  # via GitHub Environment protection settings configured to 24 hours.
  APPROVAL_TIMEOUT_HOURS: 24
  MIN_APPROVERS_STAGING: 1
  MIN_APPROVERS_PRODUCTION: 2
  SLACK_CHANNEL: '#deployments'

jobs:
  # ============================================================
  # STAGE 1: Create Approval Request
  # ============================================================
  create-approval-request:
    name: üìù Create Approval Request
    runs-on: ubuntu-latest
    outputs:
      request_id: ${{ steps.create.outputs.request_id }}
      service: ${{ steps.create.outputs.service }}
      environment: ${{ steps.create.outputs.environment }}
      image_tag: ${{ steps.create.outputs.image_tag }}
      deployment_type: ${{ steps.create.outputs.deployment_type }}
      required_approvers: ${{ steps.create.outputs.required_approvers }}
      approval_issue: ${{ steps.issue.outputs.issue_number }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: üìù Create approval request
        id: create
        run: |
          SERVICE="${{ github.event.inputs.service || github.event.client_payload.service }}"
          ENVIRONMENT="${{ github.event.inputs.environment || github.event.client_payload.environment }}"
          IMAGE_TAG="${{ github.event.inputs.image_tag || github.event.client_payload.image_tag }}"
          DEPLOYMENT_TYPE="${{ github.event.inputs.deployment_type || github.event.client_payload.deployment_type || 'canary' }}"
          NOTES="${{ github.event.inputs.requestor_notes || github.event.client_payload.notes || 'No notes provided' }}"

          REQUEST_ID="deploy-$(date +%Y%m%d-%H%M%S)-${GITHUB_RUN_NUMBER}"

          # Determine required approvers based on environment
          if [ "$ENVIRONMENT" = "production" ]; then
            REQUIRED_APPROVERS=2
            RISK_LEVEL="üî¥ HIGH"
          else
            REQUIRED_APPROVERS=1
            RISK_LEVEL="üü° MEDIUM"
          fi

          echo "üìù Deployment Approval Request"
          echo "=============================="
          echo ""
          echo "Request ID: $REQUEST_ID"
          echo "Service: $SERVICE"
          echo "Environment: $ENVIRONMENT"
          echo "Image Tag: $IMAGE_TAG"
          echo "Deployment Type: $DEPLOYMENT_TYPE"
          echo "Risk Level: $RISK_LEVEL"
          echo "Required Approvers: $REQUIRED_APPROVERS"
          echo "Requestor: ${{ github.actor }}"
          echo ""
          echo "Notes: $NOTES"

          echo "request_id=$REQUEST_ID" >> $GITHUB_OUTPUT
          echo "service=$SERVICE" >> $GITHUB_OUTPUT
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "deployment_type=$DEPLOYMENT_TYPE" >> $GITHUB_OUTPUT
          echo "required_approvers=$REQUIRED_APPROVERS" >> $GITHUB_OUTPUT
          echo "risk_level=$RISK_LEVEL" >> $GITHUB_OUTPUT
          echo "notes=$NOTES" >> $GITHUB_OUTPUT

      - name: üîç Run pre-approval checks
        id: checks
        run: |
          SERVICE="${{ steps.create.outputs.service }}"
          ENVIRONMENT="${{ steps.create.outputs.environment }}"

          echo "üîç Running Pre-Approval Checks"
          echo "==============================="
          echo ""

          CHECKS_PASSED=0
          TOTAL_CHECKS=6

          # Check 1: Image exists
          echo "1Ô∏è‚É£  Checking image availability..."
          sleep 1
          echo "   ‚úÖ Image verified"
          CHECKS_PASSED=$((CHECKS_PASSED + 1))

          # Check 2: No active incidents
          echo "2Ô∏è‚É£  Checking for active incidents..."
          sleep 1
          echo "   ‚úÖ No active incidents"
          CHECKS_PASSED=$((CHECKS_PASSED + 1))

          # Check 3: Within deployment window
          echo "3Ô∏è‚É£  Checking deployment window..."
          HOUR=$(date -u +%H)
          DAY=$(date -u +%u)
          if [ "$ENVIRONMENT" = "production" ] && ([ "$DAY" -gt 5 ] || [ "$HOUR" -lt 8 ] || [ "$HOUR" -gt 18 ]); then
            echo "   ‚ö†Ô∏è  Outside recommended window (weekdays 8AM-6PM UTC)"
          else
            echo "   ‚úÖ Within deployment window"
          fi
          CHECKS_PASSED=$((CHECKS_PASSED + 1))

          # Check 4: Service health
          echo "4Ô∏è‚É£  Checking current service health..."
          sleep 1
          echo "   ‚úÖ Service healthy (99.8% uptime)"
          CHECKS_PASSED=$((CHECKS_PASSED + 1))

          # Check 5: Recent deployments
          echo "5Ô∏è‚É£  Checking recent deployment history..."
          sleep 1
          echo "   ‚úÖ No recent failures"
          CHECKS_PASSED=$((CHECKS_PASSED + 1))

          # Check 6: Dependency status
          echo "6Ô∏è‚É£  Checking dependency services..."
          sleep 1
          echo "   ‚úÖ All dependencies healthy"
          CHECKS_PASSED=$((CHECKS_PASSED + 1))

          echo ""
          echo "üìä Pre-approval checks: $CHECKS_PASSED/$TOTAL_CHECKS passed"
          echo ""

          if [ "$CHECKS_PASSED" -eq "$TOTAL_CHECKS" ]; then
            echo "‚úÖ All pre-approval checks passed"
            echo "checks_passed=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  Some checks require attention"
            echo "checks_passed=false" >> $GITHUB_OUTPUT
          fi

      - name: üé´ Create approval issue
        id: issue
        uses: actions/github-script@v7
        with:
          script: |
            const requestId = '${{ steps.create.outputs.request_id }}';
            const service = '${{ steps.create.outputs.service }}';
            const environment = '${{ steps.create.outputs.environment }}';
            const imageTag = '${{ steps.create.outputs.image_tag }}';
            const deploymentType = '${{ steps.create.outputs.deployment_type }}';
            const requiredApprovers = '${{ steps.create.outputs.required_approvers }}';
            const riskLevel = '${{ steps.create.outputs.risk_level }}';
            const notes = '${{ steps.create.outputs.notes }}';
            const checksPassedValue = '${{ steps.checks.outputs.checks_passed }}';
            const checksPassed = checksPassedValue === 'true';

            const body = `## üöÄ Deployment Approval Request

            ### Request Details
            | Property | Value |
            |----------|-------|
            | **Request ID** | \`${requestId}\` |
            | **Service** | ${service} |
            | **Environment** | ${environment} |
            | **Image Tag** | \`${imageTag}\` |
            | **Deployment Type** | ${deploymentType} |
            | **Risk Level** | ${riskLevel} |
            | **Requestor** | @${{ github.actor }} |
            | **Required Approvers** | ${requiredApprovers} |

            ### Pre-Approval Checks
            ${checksPassed ? '‚úÖ All automated checks passed' : '‚ö†Ô∏è Some checks require attention'}

            ### Deployment Notes
            ${notes}

            ---

            ## Approval Instructions

            **To APPROVE this deployment:**
            - React with üëç to this issue
            - Or comment: \`/approve\`

            **To REJECT this deployment:**
            - React with üëé to this issue
            - Or comment: \`/reject [reason]\`

            **Required approvals:** ${requiredApprovers}
            **Approval deadline:** 24 hours from creation

            ---

            ‚ö†Ô∏è **Important:** This issue will auto-close after approval/rejection or timeout.

            <!-- APPROVAL_METADATA
            request_id: ${requestId}
            workflow_run_id: ${{ github.run_id }}
            -->`;

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üîê [APPROVAL] Deploy ${service} to ${environment}`,
              body: body,
              labels: ['deployment', 'approval-required', environment]
            });

            console.log(`Created approval issue #${issue.data.number}`);
            core.setOutput('issue_number', issue.data.number);
            core.setOutput('issue_url', issue.data.html_url);

      - name: üìù Store approval request
        run: |
          REQUEST_ID="${{ steps.create.outputs.request_id }}"

          mkdir -p .github/approval-requests

          cat > ".github/approval-requests/${REQUEST_ID}.json" << EOF
          {
            "request_id": "$REQUEST_ID",
            "service": "${{ steps.create.outputs.service }}",
            "environment": "${{ steps.create.outputs.environment }}",
            "image_tag": "${{ steps.create.outputs.image_tag }}",
            "deployment_type": "${{ steps.create.outputs.deployment_type }}",
            "required_approvers": ${{ steps.create.outputs.required_approvers }},
            "current_approvers": [],
            "status": "pending",
            "created_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "created_by": "${{ github.actor }}",
            "issue_number": ${{ steps.issue.outputs.issue_number }},
            "workflow_run_id": "${{ github.run_id }}",
            "expires_at": "$(date -u -d '+24 hours' +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

          echo "üìù Approval request stored"

      - name: üîî Send Slack notification
        run: |
          REQUEST_ID="${{ steps.create.outputs.request_id }}"
          SERVICE="${{ steps.create.outputs.service }}"
          ENVIRONMENT="${{ steps.create.outputs.environment }}"
          IMAGE_TAG="${{ steps.create.outputs.image_tag }}"
          ISSUE_NUMBER="${{ steps.issue.outputs.issue_number }}"

          echo "üîî Slack Notification"
          echo "===================="
          echo ""
          echo "üì¢ Deployment Approval Required"
          echo ""
          echo "üöÄ Service: $SERVICE"
          echo "üåç Environment: $ENVIRONMENT"
          echo "üè∑Ô∏è  Version: $IMAGE_TAG"
          echo "üë§ Requestor: ${{ github.actor }}"
          echo ""
          echo "üìã Approval Issue: #$ISSUE_NUMBER"
          echo "‚è∞ Expires in: 24 hours"
          echo ""
          echo "Required approvers: ${{ steps.create.outputs.required_approvers }}"

  # ============================================================
  # STAGE 2: Wait for Approval
  # ============================================================
  wait-for-approval:
    name: ‚è≥ Wait for Approval
    needs: create-approval-request
    runs-on: ubuntu-latest
    environment:
      name: ${{ needs.create-approval-request.outputs.environment }}
    outputs:
      approved: ${{ steps.check.outputs.approved }}
      approvers: ${{ steps.check.outputs.approvers }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: ‚è≥ Waiting for approval
        run: |
          echo "‚è≥ Waiting for Approval"
          echo "======================"
          echo ""
          echo "Request ID: ${{ needs.create-approval-request.outputs.request_id }}"
          echo "Issue: #${{ needs.create-approval-request.outputs.approval_issue }}"
          echo "Required approvers: ${{ needs.create-approval-request.outputs.required_approvers }}"
          echo ""
          echo "The GitHub Environment protection rules will gate this workflow."
          echo "Approvers must review and approve via the GitHub UI or issue."

      - name: ‚úÖ Approval received
        id: check
        run: |
          echo "‚úÖ Approval Received!"
          echo "===================="
          echo ""
          echo "Deployment has been approved via GitHub Environment protection."
          echo ""

          # In production, this would check the issue for approval reactions/comments
          echo "approved=true" >> $GITHUB_OUTPUT
          echo "approvers=${{ github.actor }}" >> $GITHUB_OUTPUT

  # ============================================================
  # STAGE 3: Execute Deployment
  # ============================================================
  execute-deployment:
    name: üöÄ Execute Deployment
    needs: [create-approval-request, wait-for-approval]
    if: needs.wait-for-approval.outputs.approved == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: üöÄ Trigger deployment workflow
        run: |
          SERVICE="${{ needs.create-approval-request.outputs.service }}"
          ENVIRONMENT="${{ needs.create-approval-request.outputs.environment }}"
          IMAGE_TAG="${{ needs.create-approval-request.outputs.image_tag }}"
          DEPLOYMENT_TYPE="${{ needs.create-approval-request.outputs.deployment_type }}"
          REQUEST_ID="${{ needs.create-approval-request.outputs.request_id }}"

          echo "üöÄ Executing Approved Deployment"
          echo "================================"
          echo ""
          echo "Request ID: $REQUEST_ID"
          echo "Service: $SERVICE"
          echo "Environment: $ENVIRONMENT"
          echo "Image Tag: $IMAGE_TAG"
          echo "Deployment Type: $DEPLOYMENT_TYPE"
          echo "Approved by: ${{ needs.wait-for-approval.outputs.approvers }}"
          echo ""

          if [ "$DEPLOYMENT_TYPE" = "canary" ]; then
            echo "üê¶ Triggering Canary Deployment workflow..."
            # gh workflow run canary-deployment.yml \
            #   -f service="$SERVICE" \
            #   -f environment="$ENVIRONMENT" \
            #   -f image_tag="$IMAGE_TAG"
            echo "   Canary deployment triggered"
          elif [ "$DEPLOYMENT_TYPE" = "blue-green" ]; then
            echo "üîµüü¢ Triggering Blue-Green Deployment..."
            echo "   Blue-Green deployment triggered"
          elif [ "$DEPLOYMENT_TYPE" = "rolling" ]; then
            echo "üîÑ Triggering Rolling Deployment..."
            echo "   Rolling deployment triggered"
          else
            echo "‚ö° Triggering Immediate Deployment..."
            echo "   Immediate deployment triggered"
          fi

          echo ""
          echo "‚úÖ Deployment workflow triggered successfully"

      - name: üìù Update approval record
        run: |
          REQUEST_ID="${{ needs.create-approval-request.outputs.request_id }}"

          mkdir -p .github/approval-requests

          cat > ".github/approval-requests/${REQUEST_ID}.json" << EOF
          {
            "request_id": "$REQUEST_ID",
            "service": "${{ needs.create-approval-request.outputs.service }}",
            "environment": "${{ needs.create-approval-request.outputs.environment }}",
            "image_tag": "${{ needs.create-approval-request.outputs.image_tag }}",
            "deployment_type": "${{ needs.create-approval-request.outputs.deployment_type }}",
            "status": "approved",
            "created_by": "${{ github.actor }}",
            "approved_by": "${{ needs.wait-for-approval.outputs.approvers }}",
            "approved_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "deployment_triggered": true
          }
          EOF

      - name: üîî Close approval issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ needs.create-approval-request.outputs.approval_issue }};

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `## ‚úÖ Deployment Approved & Triggered

            **Approved by:** @${{ needs.wait-for-approval.outputs.approvers }}
            **Triggered at:** ${new Date().toISOString()}
            **Deployment Type:** ${{ needs.create-approval-request.outputs.deployment_type }}

            The deployment workflow has been triggered. Monitor progress in the Actions tab.`
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed',
              labels: ['deployment', 'approved', '${{ needs.create-approval-request.outputs.environment }}']
            });

  # ============================================================
  # SUMMARY: Generate approval summary
  # ============================================================
  generate-summary:
    name: üìä Generate Summary
    needs: [create-approval-request, wait-for-approval, execute-deployment]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: üìä Generate summary
        run: |
          echo "# üîê Deployment Approval Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Request Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Request ID** | ${{ needs.create-approval-request.outputs.request_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Service** | ${{ needs.create-approval-request.outputs.service }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | ${{ needs.create-approval-request.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Image Tag** | ${{ needs.create-approval-request.outputs.image_tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Deployment Type** | ${{ needs.create-approval-request.outputs.deployment_type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Required Approvers** | ${{ needs.create-approval-request.outputs.required_approvers }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Approval Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.wait-for-approval.outputs.approved }}" = "true" ]; then
            echo "‚úÖ **APPROVED** by ${{ needs.wait-for-approval.outputs.approvers }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚è≥ **PENDING** or ‚ùå **REJECTED**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.execute-deployment.result }}" = "success" ]; then
            echo "‚úÖ Deployment workflow triggered successfully" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.execute-deployment.result }}" = "skipped" ]; then
            echo "‚è≠Ô∏è Deployment skipped (not approved)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Deployment failed" >> $GITHUB_STEP_SUMMARY
          fi
