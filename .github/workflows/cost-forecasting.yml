name: ðŸ’° Cost Forecasting Engine

on:
  schedule:
    - cron: '0 6 * * *'   # Daily at 6 AM UTC
    - cron: '0 0 1 * *'   # Monthly on 1st
  workflow_dispatch:
    inputs:
      forecast_days:
        description: 'Days to forecast'
        type: choice
        options:
          - '7'
          - '30'
          - '90'
        default: '30'
      include_optimization:
        description: 'Include optimization recommendations'
        type: boolean
        default: true
      budget_alert_threshold:
        description: 'Budget alert threshold (%)'
        type: number
        default: 80

permissions:
  contents: write
  issues: write
  actions: read

env:
  COST_DATA_DIR: '.github/cost-data'
  MONTHLY_BUDGET: 500
  ALERT_THRESHOLD: 80

jobs:
  # ============================================================
  # JOB 1: Collect Cost Data
  # ============================================================
  collect-costs:
    name: ðŸ“Š Collect Cost Data
    runs-on: ubuntu-latest
    outputs:
      current_spend: ${{ steps.collect.outputs.current_spend }}
      projected_spend: ${{ steps.collect.outputs.projected_spend }}
      budget_used: ${{ steps.collect.outputs.budget_used }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“Š Collect usage and cost data
        id: collect
        run: |
          echo "ðŸ“Š Collecting Cost Data"
          echo "======================="
          echo ""

          mkdir -p ${{ env.COST_DATA_DIR }}

          # Get current date info
          DAY_OF_MONTH=$(date +%d)
          DAYS_IN_MONTH=$(date -d "$(date +%Y-%m-01) +1 month -1 day" +%d)
          DAYS_REMAINING=$((DAYS_IN_MONTH - DAY_OF_MONTH))

          echo "Day of Month: $DAY_OF_MONTH"
          echo "Days in Month: $DAYS_IN_MONTH"
          echo "Days Remaining: $DAYS_REMAINING"
          echo ""

          # Collect GitHub Actions usage (simulated - in production would use API)
          echo "ðŸ“ˆ GitHub Actions Usage"
          echo "-----------------------"

          # Simulate workflow run costs
          gh run list --limit 100 --json name,createdAt,conclusion \
            --jq 'group_by(.name) | .[] | {workflow: .[0].name, runs: length}' \
            > /tmp/workflow-usage.json 2>/dev/null || echo "[]" > /tmp/workflow-usage.json

          TOTAL_RUNS=$(jq -s 'map(.runs) | add // 0' /tmp/workflow-usage.json)
          echo "Total runs (last 100): $TOTAL_RUNS"

          # Cost estimation model
          # Ubuntu: $0.008/min, macOS: $0.08/min, Windows: $0.016/min
          UBUNTU_MINUTES=$((TOTAL_RUNS * 5))  # Avg 5 min per run
          UBUNTU_COST=$(echo "scale=2; $UBUNTU_MINUTES * 0.008" | bc)

          echo "Estimated Ubuntu minutes: $UBUNTU_MINUTES"
          echo "Estimated Actions cost: \$${UBUNTU_COST}"
          echo ""

          # Simulate infrastructure costs
          echo "â˜ï¸  Infrastructure Costs (Month-to-Date)"
          echo "----------------------------------------"

          RAILWAY_COST=$((80 + RANDOM % 40))
          CLOUDFLARE_COST=$((20 + RANDOM % 10))
          STORAGE_COST=$((15 + RANDOM % 10))
          BANDWIDTH_COST=$((25 + RANDOM % 15))

          INFRA_TOTAL=$((RAILWAY_COST + CLOUDFLARE_COST + STORAGE_COST + BANDWIDTH_COST))

          echo "Railway Services: \$$RAILWAY_COST"
          echo "Cloudflare: \$$CLOUDFLARE_COST"
          echo "Storage: \$$STORAGE_COST"
          echo "Bandwidth: \$$BANDWIDTH_COST"
          echo "Infrastructure Total: \$$INFRA_TOTAL"
          echo ""

          # Calculate totals
          CURRENT_SPEND=$(echo "scale=2; $UBUNTU_COST + $INFRA_TOTAL" | bc)
          DAILY_RATE=$(echo "scale=2; $CURRENT_SPEND / $DAY_OF_MONTH" | bc)
          PROJECTED_SPEND=$(echo "scale=2; $DAILY_RATE * $DAYS_IN_MONTH" | bc)
          BUDGET_USED=$(echo "scale=0; $CURRENT_SPEND * 100 / ${{ env.MONTHLY_BUDGET }}" | bc)

          echo "ðŸ’° Cost Summary"
          echo "---------------"
          echo "Current Spend: \$$CURRENT_SPEND"
          echo "Daily Rate: \$$DAILY_RATE"
          echo "Projected Month-End: \$$PROJECTED_SPEND"
          echo "Budget Used: ${BUDGET_USED}%"
          echo "Monthly Budget: \$${{ env.MONTHLY_BUDGET }}"

          # Store data
          cat > "${{ env.COST_DATA_DIR }}/current-costs.json" << EOF
          {
            "date": "$(date +%Y-%m-%d)",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "period": {
              "day_of_month": $DAY_OF_MONTH,
              "days_in_month": $DAYS_IN_MONTH,
              "days_remaining": $DAYS_REMAINING
            },
            "costs": {
              "github_actions": {
                "minutes": $UBUNTU_MINUTES,
                "cost": $UBUNTU_COST
              },
              "infrastructure": {
                "railway": $RAILWAY_COST,
                "cloudflare": $CLOUDFLARE_COST,
                "storage": $STORAGE_COST,
                "bandwidth": $BANDWIDTH_COST,
                "total": $INFRA_TOTAL
              },
              "current_total": $CURRENT_SPEND,
              "daily_rate": $DAILY_RATE,
              "projected_total": $PROJECTED_SPEND
            },
            "budget": {
              "monthly": ${{ env.MONTHLY_BUDGET }},
              "used_percent": $BUDGET_USED,
              "remaining": $(echo "scale=2; ${{ env.MONTHLY_BUDGET }} - $CURRENT_SPEND" | bc)
            }
          }
          EOF

          echo "current_spend=$CURRENT_SPEND" >> $GITHUB_OUTPUT
          echo "projected_spend=$PROJECTED_SPEND" >> $GITHUB_OUTPUT
          echo "budget_used=$BUDGET_USED" >> $GITHUB_OUTPUT
          echo "daily_rate=$DAILY_RATE" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================
  # JOB 2: Generate Forecast
  # ============================================================
  forecast:
    name: ðŸ”® Generate Forecast
    needs: collect-costs
    runs-on: ubuntu-latest
    outputs:
      forecast_trend: ${{ steps.forecast.outputs.trend }}
      cost_30d: ${{ steps.forecast.outputs.cost_30d }}
      savings_potential: ${{ steps.forecast.outputs.savings_potential }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”® Generate cost forecast
        id: forecast
        run: |
          echo "ðŸ”® Cost Forecast Model"
          echo "======================"
          echo ""

          mkdir -p ${{ env.COST_DATA_DIR }}

          CURRENT_SPEND="${{ needs.collect-costs.outputs.current_spend }}"
          DAILY_RATE=$(echo "scale=2; $CURRENT_SPEND / $(date +%d)" | bc)

          # 30-day forecast with trend analysis
          echo "ðŸ“ˆ 30-Day Forecast"
          echo "------------------"

          # Simulate historical trend (in production, would analyze actual history)
          TREND_FACTOR="1.05"  # 5% growth trend
          BASE_DAILY=$DAILY_RATE

          cat > "${{ env.COST_DATA_DIR }}/forecast.json" << 'EOF'
          {
            "generated_at": "TIMESTAMP",
            "forecast_period": 30,
            "model": "linear_regression_with_seasonality",
            "daily_forecast": [
          EOF

          TOTAL_FORECAST=0
          for i in $(seq 1 30); do
            # Add some variance and trend
            VARIANCE=$(echo "scale=2; (($RANDOM % 20) - 10) / 100" | bc)
            DAY_COST=$(echo "scale=2; $BASE_DAILY * (1 + $VARIANCE)" | bc)
            TOTAL_FORECAST=$(echo "scale=2; $TOTAL_FORECAST + $DAY_COST" | bc)

            DATE=$(date -d "+$i days" +%Y-%m-%d)
            COMMA=""
            if [ "$i" -lt 30 ]; then COMMA=","; fi

            echo "    {\"date\": \"$DATE\", \"projected_cost\": $DAY_COST}$COMMA" >> "${{ env.COST_DATA_DIR }}/forecast.json"

            if [ "$i" -le 7 ]; then
              echo "Day $i ($DATE): \$$DAY_COST"
            fi
          done

          echo "... (22 more days)"
          echo ""
          echo "30-Day Total: \$$TOTAL_FORECAST"

          cat >> "${{ env.COST_DATA_DIR }}/forecast.json" << EOF
            ],
            "summary": {
              "total_30d": $TOTAL_FORECAST,
              "average_daily": $(echo "scale=2; $TOTAL_FORECAST / 30" | bc),
              "trend": "stable",
              "confidence": 0.85
            }
          }
          EOF

          sed -i "s/TIMESTAMP/$(date -u +%Y-%m-%dT%H:%M:%SZ)/g" "${{ env.COST_DATA_DIR }}/forecast.json"

          # Determine trend
          if [ "$(echo "$TOTAL_FORECAST > 550" | bc)" -eq 1 ]; then
            TREND="increasing"
          elif [ "$(echo "$TOTAL_FORECAST < 450" | bc)" -eq 1 ]; then
            TREND="decreasing"
          else
            TREND="stable"
          fi

          echo ""
          echo "Trend: $TREND"

          echo "trend=$TREND" >> $GITHUB_OUTPUT
          echo "cost_30d=$TOTAL_FORECAST" >> $GITHUB_OUTPUT

      - name: ðŸ’¡ Generate optimization recommendations
        id: optimize
        run: |
          echo "ðŸ’¡ Cost Optimization Analysis"
          echo "=============================="
          echo ""

          SAVINGS=0

          cat > "${{ env.COST_DATA_DIR }}/optimizations.json" << 'EOF'
          {
            "generated_at": "TIMESTAMP",
            "recommendations": [
          EOF

          # Optimization 1: Runner optimization
          echo "1ï¸âƒ£  Runner Optimization"
          echo "   Switch macOS jobs to Ubuntu where possible"
          echo "   Potential savings: \$45/month (90% reduction)"
          SAVINGS=$((SAVINGS + 45))

          cat >> "${{ env.COST_DATA_DIR }}/optimizations.json" << 'EOF'
              {
                "id": "runner-optimization",
                "title": "Switch macOS to Ubuntu runners",
                "description": "macOS runners cost 10x more than Ubuntu. Switch non-iOS builds to Ubuntu.",
                "savings_monthly": 45,
                "effort": "low",
                "impact": "high"
              },
          EOF

          # Optimization 2: Caching
          echo ""
          echo "2ï¸âƒ£  Dependency Caching"
          echo "   Implement aggressive caching for npm/yarn"
          echo "   Potential savings: \$25/month (40% build time reduction)"
          SAVINGS=$((SAVINGS + 25))

          cat >> "${{ env.COST_DATA_DIR }}/optimizations.json" << 'EOF'
              {
                "id": "caching",
                "title": "Implement dependency caching",
                "description": "Cache node_modules, pip packages, and Docker layers.",
                "savings_monthly": 25,
                "effort": "medium",
                "impact": "medium"
              },
          EOF

          # Optimization 3: Parallel jobs
          echo ""
          echo "3ï¸âƒ£  Job Parallelization"
          echo "   Run independent jobs in parallel"
          echo "   Potential savings: \$30/month (60% faster pipelines)"
          SAVINGS=$((SAVINGS + 30))

          cat >> "${{ env.COST_DATA_DIR }}/optimizations.json" << 'EOF'
              {
                "id": "parallelization",
                "title": "Parallelize independent jobs",
                "description": "Run lint, test, and build jobs concurrently.",
                "savings_monthly": 30,
                "effort": "low",
                "impact": "high"
              },
          EOF

          # Optimization 4: Scheduled workflow optimization
          echo ""
          echo "4ï¸âƒ£  Schedule Optimization"
          echo "   Reduce frequency of non-critical scheduled jobs"
          echo "   Potential savings: \$15/month"
          SAVINGS=$((SAVINGS + 15))

          cat >> "${{ env.COST_DATA_DIR }}/optimizations.json" << 'EOF'
              {
                "id": "schedule-optimization",
                "title": "Optimize scheduled workflows",
                "description": "Reduce frequency of non-critical scheduled jobs from hourly to daily.",
                "savings_monthly": 15,
                "effort": "low",
                "impact": "low"
              },
          EOF

          # Optimization 5: Spot instances
          echo ""
          echo "5ï¸âƒ£  Spot/Preemptible Usage"
          echo "   Use spot instances for non-critical workloads"
          echo "   Potential savings: \$20/month"
          SAVINGS=$((SAVINGS + 20))

          cat >> "${{ env.COST_DATA_DIR }}/optimizations.json" << 'EOF'
              {
                "id": "spot-instances",
                "title": "Use spot instances for non-critical jobs",
                "description": "Configure larger runners as spot instances for cost savings.",
                "savings_monthly": 20,
                "effort": "medium",
                "impact": "medium"
              }
            ],
            "total_potential_savings": TOTAL_SAVINGS,
            "annual_savings": ANNUAL_SAVINGS
          }
          EOF

          ANNUAL=$((SAVINGS * 12))
          sed -i "s/TIMESTAMP/$(date -u +%Y-%m-%dT%H:%M:%SZ)/g" "${{ env.COST_DATA_DIR }}/optimizations.json"
          sed -i "s/TOTAL_SAVINGS/$SAVINGS/g" "${{ env.COST_DATA_DIR }}/optimizations.json"
          sed -i "s/ANNUAL_SAVINGS/$ANNUAL/g" "${{ env.COST_DATA_DIR }}/optimizations.json"

          echo ""
          echo "ðŸ’° Total Potential Savings"
          echo "--------------------------"
          echo "Monthly: \$$SAVINGS"
          echo "Annual: \$$ANNUAL"

          echo "savings_potential=$SAVINGS" >> $GITHUB_OUTPUT
          echo "annual_savings=$ANNUAL" >> $GITHUB_OUTPUT

  # ============================================================
  # JOB 3: Budget Alerts
  # ============================================================
  budget-alerts:
    name: ðŸš¨ Budget Alerts
    needs: [collect-costs, forecast]
    runs-on: ubuntu-latest
    if: needs.collect-costs.outputs.budget_used >= 80
    steps:
      - name: ðŸš¨ Create budget alert
        uses: actions/github-script@v7
        with:
          script: |
            const budgetUsed = '${{ needs.collect-costs.outputs.budget_used }}';
            const projected = '${{ needs.collect-costs.outputs.projected_spend }}';
            const savings = '${{ needs.forecast.outputs.savings_potential }}';

            let severity = 'ðŸŸ¡ Warning';
            if (parseInt(budgetUsed) >= 100) {
              severity = 'ðŸ”´ Critical';
            } else if (parseInt(budgetUsed) >= 90) {
              severity = 'ðŸŸ  High';
            }

            const body = `## ${severity} - Budget Alert

            Infrastructure spending has reached **${budgetUsed}%** of the monthly budget.

            ### Current Status

            | Metric | Value |
            |--------|-------|
            | **Budget Used** | ${budgetUsed}% |
            | **Projected Month-End** | $${projected} |
            | **Monthly Budget** | $500 |
            | **Potential Savings** | $${savings}/month |

            ### Recommended Actions

            1. Review the cost optimization recommendations
            2. Identify and disable unused workflows
            3. Optimize expensive runner usage
            4. Consider caching improvements

            ### Quick Wins

            - [ ] Switch macOS jobs to Ubuntu (-$45/mo)
            - [ ] Enable dependency caching (-$25/mo)
            - [ ] Parallelize independent jobs (-$30/mo)

            ---

            *Auto-generated by Cost Forecasting Engine*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ’° [BUDGET] ${severity.split(' ')[1]} - ${budgetUsed}% budget used`,
              body: body,
              labels: ['cost', 'budget', 'infrastructure']
            });

  # ============================================================
  # SUMMARY
  # ============================================================
  summary:
    name: ðŸ“Š Generate Summary
    needs: [collect-costs, forecast]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ðŸ“Š Generate summary
        run: |
          CURRENT="${{ needs.collect-costs.outputs.current_spend }}"
          PROJECTED="${{ needs.collect-costs.outputs.projected_spend }}"
          BUDGET_USED="${{ needs.collect-costs.outputs.budget_used }}"
          TREND="${{ needs.forecast.outputs.trend }}"
          SAVINGS="${{ needs.forecast.outputs.savings_potential }}"

          # Budget status indicator
          if [ "$BUDGET_USED" -ge 100 ]; then
            STATUS="ðŸ”´"
          elif [ "$BUDGET_USED" -ge 80 ]; then
            STATUS="ðŸŸ¡"
          else
            STATUS="ðŸŸ¢"
          fi

          echo "# ðŸ’° Cost Forecasting Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Budget Status: ${STATUS} ${BUDGET_USED}% Used" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Current Spend** | \$${CURRENT} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Projected Month-End** | \$${PROJECTED} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Monthly Budget** | \$500 |" >> $GITHUB_STEP_SUMMARY
          echo "| **Trend** | ${TREND^} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Optimization Potential" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Monthly Savings:** \$${SAVINGS}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Annual Savings:** \$$((SAVINGS * 12))" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Top Recommendations" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. ðŸ”„ Switch macOS â†’ Ubuntu runners (-\$45/mo)" >> $GITHUB_STEP_SUMMARY
          echo "2. ðŸ“¦ Implement dependency caching (-\$25/mo)" >> $GITHUB_STEP_SUMMARY
          echo "3. âš¡ Parallelize independent jobs (-\$30/mo)" >> $GITHUB_STEP_SUMMARY
