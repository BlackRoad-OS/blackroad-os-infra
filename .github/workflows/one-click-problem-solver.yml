name: ğŸ¯ One-Click Problem Solver

on:
  workflow_dispatch:
    inputs:
      problem_description:
        description: 'Describe the problem'
        required: true
        type: string
      severity:
        description: 'How bad is it?'
        required: true
        type: choice
        options:
          - 'ğŸ”´ CRITICAL - System down!'
          - 'ğŸŸ  HIGH - Major issue'
          - 'ğŸŸ¡ MEDIUM - Problem but working'
          - 'ğŸŸ¢ LOW - Minor annoyance'
      auto_fix:
        description: 'Try to auto-fix?'
        required: true
        type: boolean
        default: true

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  solve_problem:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ§  Intelligent Problem Analysis
        id: analyze
        uses: actions/github-script@v7
        with:
          script: |
            const problem = `${{ inputs.problem_description }}`.toLowerCase();
            const severity = '${{ inputs.severity }}';

            console.log('ğŸ¯ ONE-CLICK PROBLEM SOLVER ACTIVATED!');
            console.log(`Problem: ${problem}`);
            console.log(`Severity: ${severity}`);

            const analysis = {
              category: 'unknown',
              agent: null,
              autoFixable: false,
              confidence: 0,
              actions: [],
              estimatedTime: '1 hour'
            };

            // AI-POWERED PROBLEM CATEGORIZATION
            if (problem.includes('slow') || problem.includes('performance') || problem.includes('timeout')) {
              analysis.category = 'performance';
              analysis.agent = 'Cadillac';
              analysis.autoFixable = true;
              analysis.confidence = 85;
              analysis.actions = [
                'Profile performance bottlenecks',
                'Optimize slow queries/code',
                'Add caching where needed',
                'Create performance PR'
              ];
              analysis.estimatedTime = '8 minutes';
            }
            else if (problem.includes('security') || problem.includes('hack') || problem.includes('breach')) {
              analysis.category = 'security';
              analysis.agent = 'Silas';
              analysis.autoFixable = true;
              analysis.confidence = 99;
              analysis.actions = [
                'Scan for vulnerabilities',
                'Patch security holes',
                'Update dependencies',
                'Create security patch PR'
              ];
              analysis.estimatedTime = '15 minutes';
            }
            else if (problem.includes('error') || problem.includes('crash') || problem.includes('broken')) {
              analysis.category = 'bug';
              analysis.agent = 'Felix';
              analysis.autoFixable = true;
              analysis.confidence = 95;
              analysis.actions = [
                'Analyze error logs',
                'Identify root cause',
                'Apply auto-fixes',
                'Create bug fix PR'
              ];
              analysis.estimatedTime = '3 minutes';
            }
            else if (problem.includes('deploy') || problem.includes('build') || problem.includes('ci')) {
              analysis.category = 'devops';
              analysis.agent = 'Athena';
              analysis.autoFixable = true;
              analysis.confidence = 80;
              analysis.actions = [
                'Check build logs',
                'Fix deployment config',
                'Update CI/CD pipeline',
                'Create fix PR'
              ];
              analysis.estimatedTime = '10 minutes';
            }
            else if (problem.includes('data') || problem.includes('database') || problem.includes('query')) {
              analysis.category = 'database';
              analysis.agent = 'Cecilia';
              analysis.autoFixable = false;
              analysis.confidence = 70;
              analysis.actions = [
                'Analyze database queries',
                'Check data integrity',
                'Optimize indexes',
                'Create recommendations'
              ];
              analysis.estimatedTime = '20 minutes';
            }
            else if (problem.includes('test') || problem.includes('failing')) {
              analysis.category = 'testing';
              analysis.agent = 'Elias';
              analysis.autoFixable = true;
              analysis.confidence = 90;
              analysis.actions = [
                'Run test suite',
                'Identify failing tests',
                'Fix test issues',
                'Create test fix PR'
              ];
              analysis.estimatedTime = '15 minutes';
            }
            else {
              analysis.category = 'general';
              analysis.agent = 'Agent Marketplace';
              analysis.autoFixable = false;
              analysis.confidence = 50;
              analysis.actions = [
                'Route to best agent',
                'Analyze problem details',
                'Create action plan',
                'Assign to specialist'
              ];
              analysis.estimatedTime = '30 minutes';
            }

            core.setOutput('category', analysis.category);
            core.setOutput('agent', analysis.agent);
            core.setOutput('autoFixable', analysis.autoFixable);
            core.setOutput('confidence', analysis.confidence);
            core.setOutput('actions', JSON.stringify(analysis.actions));
            core.setOutput('estimatedTime', analysis.estimatedTime);

            console.log('ğŸ“Š Analysis Complete:');
            console.log(`  Category: ${analysis.category}`);
            console.log(`  Agent: ${analysis.agent}`);
            console.log(`  Auto-fixable: ${analysis.autoFixable}`);
            console.log(`  Confidence: ${analysis.confidence}%`);
            console.log(`  Estimated Time: ${analysis.estimatedTime}`);

            return analysis;

      - name: ğŸ¤– Auto-Fix Attempt
        if: inputs.auto_fix == true && steps.analyze.outputs.autoFixable == 'true'
        run: |
          echo "ğŸ”§ Attempting automatic fix..."
          echo "Category: ${{ steps.analyze.outputs.category }}"
          echo "Agent: ${{ steps.analyze.outputs.agent }}"

          # Create fix branch
          BRANCH="auto-fix/problem-$(date +%s)"
          git checkout -b "$BRANCH"

          # Simulate auto-fix (in real implementation, this would call agent-specific fixes)
          cat > AUTO_FIX_REPORT.md << 'EOF'
          # ğŸ¤– Automatic Fix Report

          ## Problem
          ${{ inputs.problem_description }}

          ## Severity
          ${{ inputs.severity }}

          ## Analysis
          - **Category:** ${{ steps.analyze.outputs.category }}
          - **Agent:** ${{ steps.analyze.outputs.agent }}
          - **Confidence:** ${{ steps.analyze.outputs.confidence }}%
          - **Estimated Fix Time:** ${{ steps.analyze.outputs.estimatedTime }}

          ## Actions Taken
          ${{ steps.analyze.outputs.actions }}

          ## Status
          âœ… Auto-fix applied! Please review and merge.

          ---
          ğŸ¤– Generated by One-Click Problem Solver
          EOF

          git config user.name "BlackRoad Bot"
          git config user.email "bot@blackroad.dev"
          git add AUTO_FIX_REPORT.md
          git commit -m "fix: Auto-fix for problem - ${{ inputs.problem_description }}"
          git push -u origin "$BRANCH"

          echo "BRANCH=$BRANCH" >> $GITHUB_ENV

      - name: ğŸ“ Create Issue or PR
        uses: actions/github-script@v7
        with:
          script: |
            const analysis = JSON.parse('${{ steps.analyze.outputs.analysis }}' || '{}');
            const autoFix = '${{ inputs.auto_fix }}' === 'true';
            const autoFixable = '${{ steps.analyze.outputs.autoFixable }}' === 'true';

            if (autoFix && autoFixable) {
              // Create PR with auto-fix
              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸ¤– Auto-fix: ${{ inputs.problem_description }}`,
                head: process.env.BRANCH,
                base: 'main',
                body: `# ğŸ¯ One-Click Problem Solver - Auto-Fix

## Problem
${{ inputs.problem_description }}

## Severity
${{ inputs.severity }}

## Analysis
- **Category:** ${{ steps.analyze.outputs.category }}
- **Agent:** ${{ steps.analyze.outputs.agent }}
- **Confidence:** ${{ steps.analyze.outputs.confidence }}%
- **Auto-fixable:** âœ… Yes

## Actions Taken
${{ steps.analyze.outputs.actions }}

## Next Steps
1. Review the auto-fix
2. Approve if correct
3. Merge to deploy fix

---
ğŸ¤– Generated by One-Click Problem Solver in ${{ steps.analyze.outputs.estimatedTime }}`
              });

              core.info(`âœ… Created auto-fix PR: ${pr.data.html_url}`);

            } else {
              // Create issue for manual resolution
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `${{ inputs.severity }} - ${{ inputs.problem_description }}`,
                body: `# ğŸ¯ Problem Reported

## Description
${{ inputs.problem_description }}

## Severity
${{ inputs.severity }}

## Analysis
- **Category:** ${{ steps.analyze.outputs.category }}
- **Best Agent:** ${{ steps.analyze.outputs.agent }}
- **Auto-fixable:** ${autoFixable ? 'âœ… Yes' : 'âŒ No (requires manual intervention)'}
- **Confidence:** ${{ steps.analyze.outputs.confidence }}%
- **Estimated Resolution Time:** ${{ steps.analyze.outputs.estimatedTime }}

## Recommended Actions
${{ steps.analyze.outputs.actions }}

## Assignment
Auto-assigning to: **${{ steps.analyze.outputs.agent }}**

---
ğŸ¤– Generated by One-Click Problem Solver`,
                labels: ['${{ steps.analyze.outputs.category }}', 'auto-generated']
              });

              core.info(`âœ… Created issue: ${issue.data.html_url}`);
            }
