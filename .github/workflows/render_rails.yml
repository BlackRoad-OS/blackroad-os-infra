name: Render Emoji Rails

on:
  issues:
    types: [opened, edited]

permissions:
  issues: write

jobs:
  render:
    runs-on: ubuntu-latest
    steps:
      - name: Render rails + label
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || "";

            function pick(re, fallback=null) {
              const m = body.match(re);
              return m ? m[1].trim() : fallback;
            }

            // Pull values from Issue Forms markdown (works for your templates)
            const statusRaw   = pick(/ðŸš¦\s*Status\s*\n\s*([^\n]+)/i, "â­• unknown");
            const priorityRaw = pick(/ðŸŽ¯\s*Priority\s*\n\s*([^\n]+)/i, "ðŸŸ¨ P2");
            const progressRaw = pick(/ðŸ“ˆ\s*Progress.*\n\s*([0-7])/i, "0");

            const status =
              statusRaw.includes("ðŸŸ¢") ? "green" :
              statusRaw.includes("ðŸŸ¡") ? "yellow" :
              statusRaw.includes("ðŸ”´") ? "red" : "unknown";

            const pNum = (priorityRaw.match(/P[0-4]/) || ["P2"])[0];
            const prog = Math.max(0, Math.min(7, parseInt(progressRaw, 10)));

            const rails = [
              "âšªï¸âšªï¸âšªï¸âšªï¸âšªï¸âšªï¸âšªï¸",
              "ðŸŸ¢âšªï¸âšªï¸âšªï¸âšªï¸âšªï¸âšªï¸",
              "ðŸŸ¢ðŸŸ¢âšªï¸âšªï¸âšªï¸âšªï¸âšªï¸",
              "ðŸŸ¢ðŸŸ¢ðŸŸ¢âšªï¸âšªï¸âšªï¸âšªï¸",
              "ðŸŸ¢ðŸŸ¢ðŸŸ¢ðŸŸ¢âšªï¸âšªï¸âšªï¸",
              "ðŸŸ¢ðŸŸ¢ðŸŸ¢ðŸŸ¢ðŸŸ¢âšªï¸âšªï¸",
              "ðŸŸ¢ðŸŸ¢ðŸŸ¢ðŸŸ¢ðŸŸ¢ðŸŸ¢âšªï¸",
              "ðŸŸ¢ðŸŸ¢ðŸŸ¢ðŸŸ¢ðŸŸ¢ðŸŸ¢ðŸŸ¢",
            ];

            const traffic = status === "green" ? "ðŸŸ¢ðŸŸ¢ðŸŸ¢ðŸŸ¢ðŸŸ¢ðŸŸ¢ðŸŸ¢"
                         : status === "yellow" ? "ðŸŸ¡ðŸŸ¡ðŸŸ¡ðŸŸ¡ðŸŸ¡ðŸŸ¡ðŸŸ¡"
                         : status === "red" ? "ðŸ”´ðŸ”´ðŸ”´ðŸ”´ðŸ”´ðŸ”´ðŸ”´"
                         : "â­•â­•â­•â­•â­•â­•â­•";

            const sad = [
              "ðŸ™‚ðŸ™‚ðŸ™‚ðŸ™‚ðŸ™‚ðŸ™‚ðŸ™‚",
              "ðŸ˜ðŸ™‚ðŸ™‚ðŸ™‚ðŸ™‚ðŸ™‚ðŸ™‚",
              "ðŸ™ðŸ˜ðŸ™‚ðŸ™‚ðŸ™‚ðŸ™‚ðŸ™‚",
              "â˜¹ï¸ðŸ™ðŸ˜ðŸ™‚ðŸ™‚ðŸ™‚ðŸ™‚",
              "ðŸ˜¢â˜¹ï¸ðŸ™ðŸ˜ðŸ™‚ðŸ™‚ðŸ™‚",
              "ðŸ˜­ðŸ˜¢â˜¹ï¸ðŸ™ðŸ˜ðŸ™‚ðŸ™‚",
              "ðŸ˜­ðŸ˜­ðŸ˜¢â˜¹ï¸ðŸ™ðŸ˜ðŸ™‚",
              "ðŸ˜­ðŸ˜­ðŸ˜­ðŸ˜¢â˜¹ï¸ðŸ™ðŸ˜",
            ];

            const comment = [
              "## ðŸš‚ TEMPIES Rails",
              "",
              `**ðŸš¦ Status:** ${statusRaw}  â†’  ${traffic}`,
              `**ðŸŽ¯ Priority:** ${priorityRaw}`,
              `**ðŸ“ˆ Progress:** ${prog}/7`,
              "",
              "### ðŸ“ˆ Progress Bar",
              rails[prog],
              "",
              "### ðŸ˜­ Sad Bar",
              sad[prog],
              "",
              "### âœ… Ship Signal",
              prog === 7 ? "âœ…âœ…âœ…âœ…âœ…âœ…âœ…" : "â­•â­•â­•â­•â­•â­•â­•",
            ].join("\n");

            // Apply labels (create these labels once in the repo)
            const labels = [
              `status:${status}`,
              `priority:${pNum}`,
              `progress:${prog}/7`
            ];

            try {
              await github.rest.issues.addLabels({
                ...context.repo,
                issue_number: context.payload.issue.number,
                labels
              });
            } catch (error) {
              console.log(`Note: Some labels may not exist yet. Please create: ${labels.join(', ')}`);
              // Continue even if labels fail - the comment is more important
            }

            // Update existing comment or create new one
            const comments = await github.rest.issues.listComments({
              ...context.repo,
              issue_number: context.payload.issue.number,
              per_page: 100
            });

            const existingComment = comments.data.find(c => (c.body || "").includes("## ðŸš‚ TEMPIES Rails"));
            
            if (existingComment) {
              // Update existing comment on edit
              await github.rest.issues.updateComment({
                ...context.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.payload.issue.number,
                body: comment
              });
            }
