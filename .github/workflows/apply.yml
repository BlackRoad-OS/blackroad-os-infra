name: terraform-apply

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Workspace to apply (dev/prod)"
        required: false
        default: "prod"
  push:
    branches:
      - main
    paths:
      - 'terraform/**'
      - 'modules/**'
      - '.github/workflows/**'
      - 'scripts/**'
      - 'docs/**'
      - 'README.md'

permissions:
  contents: write

jobs:
  apply:
    runs-on: ubuntu-latest
    env:
      TF_IN_AUTOMATION: "true"
      REQUESTED_ENV: ${{ github.event.inputs.environment || 'prod' }}
      TF_STATE_BUCKET: ${{ secrets.TF_STATE_BUCKET }}
      WORKING_DIR: terraform/environments/${{ github.event.inputs.environment || 'prod' }}
    steps:
      - name: Checkout
        uses: actions/checkout@f43a3398dc5d8737c2dbc7bf8ad6b50918d7a3d4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: 1.8.5

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@19a52fbac37dacb22a09518e4ef6ee234f2d4987 # v4.0.0
        with:
          tflint_version: latest

      - name: Setup tfsec
        uses: aquasecurity/setup-tfsec@v1

      - name: Setup Python
        uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d # v5.1.0
        with:
          python-version: '3.x'

      - name: Install checkov
        run: pip install checkov

      - name: Install Node toolchain
        uses: actions/setup-node@b829d2ab59ffb3738572edf3c6dbd9bfebc477f1
        with:
          node-version: '20'

      - name: Install npm deps
        run: npm ci

      - name: Lint and format
        run: bash scripts/fmt.sh

      - name: Terraform init
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
        run: |
          BUCKET=${TF_STATE_BUCKET:-""}
          INIT_FLAGS="-backend-config=backend.tfvars"
          if [ -n "$BUCKET" ]; then
            INIT_FLAGS="$INIT_FLAGS -backend-config=\"bucket=$BUCKET\""
          fi
          terraform init $INIT_FLAGS
        working-directory: ${{ env.WORKING_DIR }}

      - name: Terraform apply
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: terraform apply -auto-approve -var-file=terraform.tfvars
        working-directory: ${{ env.WORKING_DIR }}

      - name: Generate signature beacon
        run: npx ts-node scripts/gen_sig_beacon.ts

      - name: TODO commit beacon to archive
        run: echo "TODO(infra-next): commit sig.beacon.json to archive repo via GH API"
