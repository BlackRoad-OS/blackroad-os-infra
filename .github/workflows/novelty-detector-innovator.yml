name: Novelty Detector & Innovator

on:
  issues:
    types: [opened]
  pull_request:
    types: [opened]
  schedule:
    - cron: '0 0 * * 0'  # Weekly
  workflow_dispatch:

permissions:
  issues: write
  pull-requests: write

jobs:
  detect-novel-ideas:
    name: Detect Novel Ideas
    runs-on: ubuntu-latest
    outputs:
      novelty_score: ${{ steps.detect.outputs.score }}
      is_innovative: ${{ steps.detect.outputs.innovative }}
    steps:
      - uses: actions/checkout@v4

      - name: Analyze for novelty
        id: detect
        uses: actions/github-script@v7
        with:
          script: |
            let noveltyScore = 0;
            let text = '';

            if (context.payload.issue) {
              text = context.payload.issue.title + ' ' + context.payload.issue.body;
            } else if (context.payload.pull_request) {
              text = context.payload.pull_request.title + ' ' + context.payload.pull_request.body;
            }

            text = text.toLowerCase();

            // Check for novel keywords
            const novelKeywords = [
              'new', 'novel', 'innovative', 'revolutionary', 'unique',
              'breakthrough', 'pioneering', 'cutting-edge', 'first', 'never'
            ];

            for (const keyword of novelKeywords) {
              if (text.includes(keyword)) noveltyScore += 10;
            }

            // Check for technical innovation
            const techKeywords = [
              'ai', 'ml', 'machine learning', 'neural', 'quantum',
              'blockchain', 'edge computing', 'serverless', 'wasm'
            ];

            for (const keyword of techKeywords) {
              if (text.includes(keyword)) noveltyScore += 15;
            }

            // Check for cross-domain concepts
            if (text.includes('combine') || text.includes('integrate') || text.includes('merge')) {
              noveltyScore += 20;
            }

            const isInnovative = noveltyScore >= 30;

            core.setOutput('score', noveltyScore);
            core.setOutput('innovative', isInnovative ? 'true' : 'false');

            console.log(`Novelty score: ${noveltyScore}, Innovative: ${isInnovative}`);

  highlight-innovations:
    name: Highlight Innovative Ideas
    runs-on: ubuntu-latest
    needs: detect-novel-ideas
    if: needs.detect-novel-ideas.outputs.is_innovative == 'true'
    steps:
      - name: Celebrate innovation
        uses: actions/github-script@v7
        with:
          script: |
            const number = context.payload.issue?.number || context.payload.pull_request?.number;
            const score = '${{ needs.detect-novel-ideas.outputs.novelty_score }}';

            if (number) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: number,
                body: `## ðŸŒŸ Innovation Detected!

                **Novelty Score:** ${score}/100

                This idea shows innovative thinking! We love fresh perspectives!

                ðŸŽ¨ Keep the creative ideas coming!
                ðŸ’¡ This will be highlighted in our innovation showcase
                ðŸš€ Novel approaches like this drive progress

                ---
                ðŸ¤– Novelty Detector & Innovator`
              });

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: number,
                labels: ['innovative', 'novel-idea']
              }).catch(() => {});
            }

  create-innovation-showcase:
    name: Create Innovation Showcase
    runs-on: ubuntu-latest
    steps:
      - name: Build showcase
        uses: actions/github-script@v7
        with:
          script: |
            const { data: innovations } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'innovative',
              state: 'all',
              per_page: 20,
              sort: 'created',
              direction: 'desc'
            });

            const showcase = `## ðŸŒŸ Innovation Showcase

            **Celebrating creative thinking and novel ideas!**

            ### Recent Innovations

            ${innovations.slice(0, 10).map((item, i) =>
              `${i + 1}. [${item.title}](#${item.number}) - ${item.state === 'closed' ? 'âœ… Implemented' : 'ðŸ”„ In Progress'}`
            ).join('\n')}

            ### ðŸ’¡ We Value Innovation!

            - Novel ideas are highlighted and prioritized
            - Innovative thinking drives our roadmap
            - We celebrate creative solutions

            ### Share Your Ideas!

            Have a novel concept? We want to hear it!
            - Open an issue with your idea
            - Tag it with \`suggestion\`
            - Our AI will detect novelty automatically

            ---
            ðŸŒŸ Innovation is celebrated here!
            `;

            // Update or create showcase
            const { data: existing } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'innovation-showcase',
              state: 'open'
            });

            if (existing.length > 0) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing[0].number,
                body: showcase
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸŒŸ Innovation Showcase',
                body: showcase,
                labels: ['innovation-showcase', 'pinned']
              });
            }

  novelty-summary:
    name: Novelty Summary
    runs-on: ubuntu-latest
    needs: detect-novel-ideas
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# ðŸŒŸ Novelty Detection Summary" >> $GITHUB_STEP_SUMMARY
          echo "Novelty Score: ${{ needs.detect-novel-ideas.outputs.novelty_score }}" >> $GITHUB_STEP_SUMMARY
          echo "Innovative: ${{ needs.detect-novel-ideas.outputs.is_innovative }}" >> $GITHUB_STEP_SUMMARY
