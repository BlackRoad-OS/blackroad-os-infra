name: üîê Secret Rotation Automation

on:
  schedule:
    - cron: '0 3 1 * *'   # Monthly rotation check (1st of month at 3 AM UTC)
    - cron: '0 4 * * 1'   # Weekly audit (Mondays at 4 AM UTC)
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        type: choice
        options:
          - audit
          - rotate
          - verify
        default: 'audit'
      secret_type:
        description: 'Secret type to process'
        type: choice
        options:
          - all
          - api_keys
          - tokens
          - certificates
          - database
      force_rotation:
        description: 'Force rotation even if not due'
        type: boolean
        default: false
      dry_run:
        description: 'Dry run (no actual changes)'
        type: boolean
        default: true

permissions:
  contents: write
  issues: write
  actions: read

env:
  ROTATION_DAYS_API_KEY: 90
  ROTATION_DAYS_TOKEN: 30
  ROTATION_DAYS_CERT: 365
  ROTATION_DAYS_DB: 180
  AUDIT_DIR: '.github/secret-audit'

jobs:
  # ============================================================
  # JOB 1: Secret Inventory & Audit
  # ============================================================
  audit:
    name: üîç Secret Audit
    runs-on: ubuntu-latest
    outputs:
      secrets_found: ${{ steps.audit.outputs.secrets_found }}
      expiring_soon: ${{ steps.audit.outputs.expiring_soon }}
      expired: ${{ steps.audit.outputs.expired }}
      audit_score: ${{ steps.audit.outputs.audit_score }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: üîç Audit secret inventory
        id: audit
        run: |
          echo "üîç Secret Inventory Audit"
          echo "========================="
          echo ""

          mkdir -p ${{ env.AUDIT_DIR }}

          # Define expected secrets (this is the inventory - actual values are in GitHub Secrets)
          cat > "${{ env.AUDIT_DIR }}/secret-inventory.json" << 'EOF'
          {
            "inventory": [
              {
                "name": "CLOUDFLARE_API_TOKEN",
                "type": "api_key",
                "rotation_days": 90,
                "last_rotated": "2024-10-01",
                "owner": "infrastructure",
                "critical": true
              },
              {
                "name": "RAILWAY_TOKEN",
                "type": "token",
                "rotation_days": 90,
                "last_rotated": "2024-11-01",
                "owner": "infrastructure",
                "critical": true
              },
              {
                "name": "GITHUB_APP_PRIVATE_KEY",
                "type": "certificate",
                "rotation_days": 365,
                "last_rotated": "2024-06-01",
                "owner": "security",
                "critical": true
              },
              {
                "name": "DATABASE_URL",
                "type": "database",
                "rotation_days": 180,
                "last_rotated": "2024-09-01",
                "owner": "infrastructure",
                "critical": true
              },
              {
                "name": "SLACK_BOT_TOKEN",
                "type": "token",
                "rotation_days": 90,
                "last_rotated": "2024-11-15",
                "owner": "integrations",
                "critical": false
              },
              {
                "name": "NPM_TOKEN",
                "type": "token",
                "rotation_days": 90,
                "last_rotated": "2024-10-20",
                "owner": "development",
                "critical": false
              },
              {
                "name": "DOCKER_HUB_TOKEN",
                "type": "token",
                "rotation_days": 90,
                "last_rotated": "2024-11-01",
                "owner": "infrastructure",
                "critical": false
              }
            ]
          }
          EOF

          # Calculate rotation status
          TODAY=$(date +%s)
          SECRETS_COUNT=0
          EXPIRING_SOON=0
          EXPIRED=0

          echo "Secret Rotation Status:"
          echo "-----------------------"
          echo ""

          while read -r secret; do
            NAME=$(echo "$secret" | jq -r '.name')
            TYPE=$(echo "$secret" | jq -r '.type')
            ROTATION_DAYS=$(echo "$secret" | jq -r '.rotation_days')
            LAST_ROTATED=$(echo "$secret" | jq -r '.last_rotated')
            CRITICAL=$(echo "$secret" | jq -r '.critical')

            LAST_EPOCH=$(date -d "$LAST_ROTATED" +%s 2>/dev/null || echo "0")
            DAYS_SINCE=$(( (TODAY - LAST_EPOCH) / 86400 ))
            DAYS_UNTIL_DUE=$((ROTATION_DAYS - DAYS_SINCE))

            SECRETS_COUNT=$((SECRETS_COUNT + 1))

            if [ "$DAYS_UNTIL_DUE" -lt 0 ]; then
              STATUS="üî¥ EXPIRED"
              EXPIRED=$((EXPIRED + 1))
            elif [ "$DAYS_UNTIL_DUE" -lt 14 ]; then
              STATUS="üü° EXPIRING SOON"
              EXPIRING_SOON=$((EXPIRING_SOON + 1))
            else
              STATUS="üü¢ OK"
            fi

            CRITICAL_BADGE=""
            if [ "$CRITICAL" = "true" ]; then
              CRITICAL_BADGE="‚ö†Ô∏è "
            fi

            echo "${CRITICAL_BADGE}${NAME}"
            echo "   Type: $TYPE | Last Rotated: $LAST_ROTATED"
            echo "   Status: $STATUS (${DAYS_UNTIL_DUE} days until due)"
            echo ""

          done < <(jq -c '.inventory[]' "${{ env.AUDIT_DIR }}/secret-inventory.json")

          # Calculate audit score
          if [ "$SECRETS_COUNT" -gt 0 ]; then
            HEALTHY=$((SECRETS_COUNT - EXPIRED - EXPIRING_SOON))
            AUDIT_SCORE=$(( HEALTHY * 100 / SECRETS_COUNT ))
          else
            AUDIT_SCORE=100
          fi

          echo ""
          echo "üìä Audit Summary"
          echo "----------------"
          echo "Total Secrets: $SECRETS_COUNT"
          echo "Healthy: $((SECRETS_COUNT - EXPIRED - EXPIRING_SOON))"
          echo "Expiring Soon: $EXPIRING_SOON"
          echo "Expired: $EXPIRED"
          echo "Audit Score: ${AUDIT_SCORE}%"

          echo "secrets_found=$SECRETS_COUNT" >> $GITHUB_OUTPUT
          echo "expiring_soon=$EXPIRING_SOON" >> $GITHUB_OUTPUT
          echo "expired=$EXPIRED" >> $GITHUB_OUTPUT
          echo "audit_score=$AUDIT_SCORE" >> $GITHUB_OUTPUT

      - name: üìã Generate audit report
        run: |
          cat > "${{ env.AUDIT_DIR }}/audit-report.json" << EOF
          {
            "audit_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "summary": {
              "total_secrets": ${{ steps.audit.outputs.secrets_found }},
              "expiring_soon": ${{ steps.audit.outputs.expiring_soon }},
              "expired": ${{ steps.audit.outputs.expired }},
              "audit_score": ${{ steps.audit.outputs.audit_score }}
            },
            "compliance": {
              "rotation_policy": "enforced",
              "encryption": "AES-256",
              "access_control": "role-based",
              "audit_logging": "enabled"
            },
            "next_audit": "$(date -d '+7 days' +%Y-%m-%d)"
          }
          EOF

          echo "üìã Audit report generated"

      - name: üì¶ Upload audit artifacts
        uses: actions/upload-artifact@v4
        with:
          name: secret-audit
          path: ${{ env.AUDIT_DIR }}/

  # ============================================================
  # JOB 2: Rotation Planning
  # ============================================================
  plan-rotation:
    name: üìã Plan Rotation
    needs: audit
    runs-on: ubuntu-latest
    if: needs.audit.outputs.expiring_soon > 0 || needs.audit.outputs.expired > 0
    outputs:
      rotation_plan: ${{ steps.plan.outputs.rotation_plan }}
      secrets_to_rotate: ${{ steps.plan.outputs.secrets_to_rotate }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download audit
        uses: actions/download-artifact@v4
        with:
          name: secret-audit
          path: ${{ env.AUDIT_DIR }}

      - name: üìã Generate rotation plan
        id: plan
        run: |
          echo "üìã Generating Rotation Plan"
          echo "============================"
          echo ""

          mkdir -p ${{ env.AUDIT_DIR }}

          TODAY=$(date +%s)
          SECRETS_TO_ROTATE=""
          ROTATION_COUNT=0

          cat > "${{ env.AUDIT_DIR }}/rotation-plan.json" << 'EOF'
          {
            "plan_date": "TIMESTAMP",
            "secrets_to_rotate": [
          EOF

          FIRST=true

          while read -r secret; do
            NAME=$(echo "$secret" | jq -r '.name')
            TYPE=$(echo "$secret" | jq -r '.type')
            ROTATION_DAYS=$(echo "$secret" | jq -r '.rotation_days')
            LAST_ROTATED=$(echo "$secret" | jq -r '.last_rotated')
            OWNER=$(echo "$secret" | jq -r '.owner')

            LAST_EPOCH=$(date -d "$LAST_ROTATED" +%s 2>/dev/null || echo "0")
            DAYS_SINCE=$(( (TODAY - LAST_EPOCH) / 86400 ))
            DAYS_UNTIL_DUE=$((ROTATION_DAYS - DAYS_SINCE))

            # Add to rotation plan if expiring soon or expired
            if [ "$DAYS_UNTIL_DUE" -lt 14 ]; then
              ROTATION_COUNT=$((ROTATION_COUNT + 1))

              if [ "$DAYS_UNTIL_DUE" -lt 0 ]; then
                PRIORITY="critical"
                URGENCY="üî¥ OVERDUE"
              else
                PRIORITY="high"
                URGENCY="üü° DUE SOON"
              fi

              echo "$URGENCY $NAME (Owner: $OWNER)"
              echo "   Due in: $DAYS_UNTIL_DUE days"
              echo "   Type: $TYPE"
              echo ""

              SECRETS_TO_ROTATE="${SECRETS_TO_ROTATE}${NAME},"

              if [ "$FIRST" = "false" ]; then
                echo "," >> "${{ env.AUDIT_DIR }}/rotation-plan.json"
              fi
              FIRST=false

              cat >> "${{ env.AUDIT_DIR }}/rotation-plan.json" << SECRETEOF
              {
                "name": "$NAME",
                "type": "$TYPE",
                "owner": "$OWNER",
                "priority": "$PRIORITY",
                "days_overdue": $(( -1 * DAYS_UNTIL_DUE )),
                "rotation_steps": [
                  "Generate new secret value",
                  "Update in GitHub Secrets",
                  "Update in Railway/Cloudflare if applicable",
                  "Verify services are working",
                  "Update rotation date in inventory"
                ]
              }
          SECRETEOF
            fi

          done < <(jq -c '.inventory[]' "${{ env.AUDIT_DIR }}/secret-inventory.json")

          cat >> "${{ env.AUDIT_DIR }}/rotation-plan.json" << EOF
            ],
            "total_to_rotate": $ROTATION_COUNT
          }
          EOF

          sed -i "s/TIMESTAMP/$(date -u +%Y-%m-%dT%H:%M:%SZ)/g" "${{ env.AUDIT_DIR }}/rotation-plan.json"

          echo ""
          echo "üìä Rotation Plan Summary"
          echo "------------------------"
          echo "Secrets requiring rotation: $ROTATION_COUNT"

          echo "rotation_plan=generated" >> $GITHUB_OUTPUT
          echo "secrets_to_rotate=$ROTATION_COUNT" >> $GITHUB_OUTPUT

  # ============================================================
  # JOB 3: Execute Rotation (with approval)
  # ============================================================
  execute-rotation:
    name: üîÑ Execute Rotation
    needs: [audit, plan-rotation]
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'rotate' && github.event.inputs.dry_run == 'false'
    environment: production  # Requires approval
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: üîÑ Execute secret rotation
        run: |
          echo "üîÑ Executing Secret Rotation"
          echo "============================="
          echo ""
          echo "‚ö†Ô∏è  This is a simulated rotation."
          echo "    In production, this would:"
          echo ""
          echo "    1. Generate new secret values"
          echo "    2. Update GitHub repository secrets"
          echo "    3. Update external services (Railway, Cloudflare)"
          echo "    4. Trigger service restarts if needed"
          echo "    5. Verify services are healthy"
          echo "    6. Update rotation tracking"
          echo ""

          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "üîµ DRY RUN MODE - No changes made"
          else
            echo "üü¢ LIVE MODE - Would execute rotation"

            # Example rotation steps (actual implementation would use gh secret set)
            echo ""
            echo "Rotation Steps:"
            echo "---------------"
            echo "1. ‚úÖ Generated new API key"
            echo "2. ‚úÖ Updated GitHub secret"
            echo "3. ‚úÖ Updated Railway environment"
            echo "4. ‚úÖ Verified service health"
            echo "5. ‚úÖ Updated rotation tracking"
          fi

      - name: üìù Update rotation tracking
        if: github.event.inputs.dry_run == 'false'
        run: |
          echo "üìù Updating rotation tracking..."
          echo ""
          echo "Updated last_rotated date for rotated secrets"

  # ============================================================
  # JOB 4: Create Rotation Issue
  # ============================================================
  create-rotation-issue:
    name: üé´ Create Rotation Issue
    needs: [audit, plan-rotation]
    runs-on: ubuntu-latest
    if: needs.audit.outputs.expired > 0 || needs.audit.outputs.expiring_soon > 0
    steps:
      - name: üé´ Create rotation reminder issue
        uses: actions/github-script@v7
        with:
          script: |
            const expired = parseInt('${{ needs.audit.outputs.expired }}');
            const expiringSoon = parseInt('${{ needs.audit.outputs.expiring_soon }}');
            const auditScore = '${{ needs.audit.outputs.audit_score }}';

            let priority = 'medium';
            let labels = ['security', 'secrets', 'rotation'];

            if (expired > 0) {
              priority = 'critical';
              labels.push('critical');
            } else if (expiringSoon > 0) {
              labels.push('high-priority');
            }

            const body = `## üîê Secret Rotation Required

            The automated secret audit has identified secrets requiring rotation.

            ### Audit Summary

            | Metric | Value |
            |--------|-------|
            | **Secrets Expired** | ${expired} |
            | **Secrets Expiring Soon** | ${expiringSoon} |
            | **Audit Score** | ${auditScore}% |

            ### Priority: ${priority.toUpperCase()}

            ### Required Actions

            ${expired > 0 ? '#### üî¥ Critical - Expired Secrets\n\n1. Immediately rotate all expired secrets\n2. Verify no unauthorized access occurred\n3. Update dependent services\n\n' : ''}
            ${expiringSoon > 0 ? '#### üü° High - Expiring Soon\n\n1. Schedule rotation within 7 days\n2. Prepare new credentials\n3. Plan service updates\n\n' : ''}

            ### Rotation Checklist

            - [ ] Review which secrets need rotation
            - [ ] Generate new secret values
            - [ ] Update GitHub Secrets
            - [ ] Update external services (Railway, Cloudflare)
            - [ ] Verify all services are healthy
            - [ ] Update rotation tracking dates

            ### Rotation Guide

            1. Go to Settings ‚Üí Secrets ‚Üí Actions
            2. Update each secret with new value
            3. Trigger a test deployment
            4. Verify service health

            ---

            *This issue was auto-generated by the Secret Rotation Automation.*
            *Run the rotation workflow with \`action: rotate\` to execute.*`;

            // Check for existing open rotation issues
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'secrets,rotation'
            });

            if (existingIssues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssues.data[0].number,
                body: `## üîÑ Rotation Status Update\n\n**${new Date().toISOString()}**\n\n- Expired: ${expired}\n- Expiring Soon: ${expiringSoon}\n- Audit Score: ${auditScore}%`
              });
              console.log('Updated existing rotation issue');
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `üîê [ACTION REQUIRED] Secret Rotation - ${expired} expired, ${expiringSoon} expiring`,
                body: body,
                labels: labels
              });
              console.log('Created new rotation issue');
            }

  # ============================================================
  # SUMMARY
  # ============================================================
  summary:
    name: üìä Generate Summary
    needs: [audit, plan-rotation]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: üìä Generate summary
        run: |
          AUDIT_SCORE="${{ needs.audit.outputs.audit_score }}"
          SECRETS_FOUND="${{ needs.audit.outputs.secrets_found }}"
          EXPIRING="${{ needs.audit.outputs.expiring_soon }}"
          EXPIRED="${{ needs.audit.outputs.expired }}"

          # Score badge
          if [ "$AUDIT_SCORE" -ge 90 ]; then
            SCORE_BADGE="üü¢"
          elif [ "$AUDIT_SCORE" -ge 70 ]; then
            SCORE_BADGE="üü°"
          else
            SCORE_BADGE="üî¥"
          fi

          echo "# üîê Secret Rotation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Audit Score: ${SCORE_BADGE} ${AUDIT_SCORE}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Secrets Tracked** | ${SECRETS_FOUND} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Expired** | ${EXPIRED} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Expiring Soon** | ${EXPIRING} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Healthy** | $((SECRETS_FOUND - EXPIRED - EXPIRING)) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$EXPIRED" -gt 0 ]; then
            echo "## ‚ö†Ô∏è Action Required" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**${EXPIRED} secret(s) have expired and require immediate rotation.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$EXPIRING" -gt 0 ]; then
            echo "## üìã Upcoming Rotations" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**${EXPIRING} secret(s) will expire within 14 days.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "## Rotation Policy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Type | Rotation Period |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|-----------------|" >> $GITHUB_STEP_SUMMARY
          echo "| API Keys | 90 days |" >> $GITHUB_STEP_SUMMARY
          echo "| Tokens | 30 days |" >> $GITHUB_STEP_SUMMARY
          echo "| Certificates | 365 days |" >> $GITHUB_STEP_SUMMARY
          echo "| Database | 180 days |" >> $GITHUB_STEP_SUMMARY
