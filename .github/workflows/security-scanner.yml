name: Security Vulnerability Scanner

on:
  schedule:
    - cron: '0 0 * * *'  # Daily
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  scan-dependencies:
    name: Scan Dependencies
    runs-on: ubuntu-latest
    outputs:
      vulns_found: ${{ steps.scan.outputs.count }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Scan npm dependencies
        if: hashFiles('package.json') != ''
        run: |
          npm audit --json > audit.json || true
          vulns=$(jq '.metadata.vulnerabilities.total // 0' audit.json)
          echo "count=$vulns" >> $GITHUB_OUTPUT
          echo "Found $vulns vulnerabilities"
      
      - name: Scan Python dependencies
        if: hashFiles('requirements.txt') != ''
        run: |
          pip install safety
          safety check --json > safety.json || true
          echo "Python security scan complete"

  scan-code:
    name: Scan Source Code
    runs-on: ubuntu-latest
    outputs:
      issues_found: ${{ steps.scan.outputs.issues }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Scan for secrets
        run: |
          echo "Scanning for hardcoded secrets..."
          issues=0
          
          if grep -r "password\s*=\s*['\"]" . --exclude-dir={.git,node_modules} 2>/dev/null; then
            echo "âš ï¸ Found hardcoded passwords"
            ((issues++))
          fi
          
          if grep -r "api_key\s*=\s*['\"]" . --exclude-dir={.git,node_modules} 2>/dev/null; then
            echo "âš ï¸ Found hardcoded API keys"
            ((issues++))
          fi
          
          echo "issues=$issues" >> $GITHUB_OUTPUT

  create-security-report:
    name: Create Security Report
    runs-on: ubuntu-latest
    needs: [scan-dependencies, scan-code]
    steps:
      - name: Generate report
        run: |
          echo "# ðŸ”’ Security Scan Report" >> $GITHUB_STEP_SUMMARY
          echo "Dependency vulnerabilities: ${{ needs.scan-dependencies.outputs.vulns_found }}" >> $GITHUB_STEP_SUMMARY
          echo "Code issues: ${{ needs.scan-code.outputs.issues_found }}" >> $GITHUB_STEP_SUMMARY
