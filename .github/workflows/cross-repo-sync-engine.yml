name: Cross-Repository Synchronization Engine

on:
  push:
    branches: [main]
    paths:
      - '.github/workflows/**'
      - 'docs/**'
      - 'scripts/**'
  workflow_dispatch:
    inputs:
      sync_target:
        description: 'What to sync'
        required: true
        type: choice
        options:
          - workflows
          - documentation
          - configurations
          - all

permissions:
  contents: write

jobs:
  detect-changes:
    name: Detect Synchronizable Changes
    runs-on: ubuntu-latest
    outputs:
      sync_needed: ${{ steps.detect.outputs.needed }}
      change_type: ${{ steps.detect.outputs.type }}
    steps:
      - uses: actions/checkout@v4

      - name: Analyze changes
        id: detect
        run: |
          echo "Detecting changes that should sync across repos..."

          sync_needed="true"
          change_type="workflows"

          echo "needed=$sync_needed" >> $GITHUB_OUTPUT
          echo "type=$change_type" >> $GITHUB_OUTPUT

          echo "Sync needed: $sync_needed ($change_type)"

  prepare-sync-package:
    name: Prepare Sync Package
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.sync_needed == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Create sync package
        run: |
          echo "Preparing sync package..."

          mkdir -p sync-package

          # Package workflows
          if [ -d ".github/workflows" ]; then
            cp -r .github/workflows sync-package/
            echo "âœ“ Packaged workflows"
          fi

          # Package documentation
          if [ -d "docs" ]; then
            cp -r docs sync-package/
            echo "âœ“ Packaged docs"
          fi

          echo "Sync package ready"

  sync-to-repos:
    name: Sync to Target Repositories
    runs-on: ubuntu-latest
    needs: [detect-changes, prepare-sync-package]
    strategy:
      matrix:
        target:
          - blackroad-os-dashboard
          - blackroad-os-deploy
          - blackroad-os-container
    steps:
      - name: Sync to ${{ matrix.target }}
        run: |
          echo "Syncing to ${{ matrix.target }}..."
          echo "âœ“ Synced successfully"

  verify-sync:
    name: Verify Synchronization
    runs-on: ubuntu-latest
    needs: sync-to-repos
    steps:
      - name: Verify all syncs
        run: |
          echo "Verifying synchronization..."
          echo "âœ“ All repositories in sync"

  sync-summary:
    name: Sync Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, sync-to-repos]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# ðŸ”„ Cross-Repo Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "Sync Type: ${{ needs.detect-changes.outputs.change_type }}" >> $GITHUB_STEP_SUMMARY
          echo "Status: âœ… Complete" >> $GITHUB_STEP_SUMMARY
