name: Intelligent Log Analyzer

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

permissions:
  issues: write
  actions: read

jobs:
  collect-logs:
    name: Collect System Logs
    runs-on: ubuntu-latest
    outputs:
      error_count: ${{ steps.collect.outputs.errors }}
      warning_count: ${{ steps.collect.outputs.warnings }}
    steps:
      - name: Collect workflow logs
        id: collect
        uses: actions/github-script@v7
        with:
          script: |
            // Get recent workflow runs
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 50
            });

            let errors = 0;
            let warnings = 0;

            for (const run of runs.workflow_runs) {
              if (run.conclusion === 'failure') errors++;
              if (run.conclusion === 'cancelled') warnings++;
            }

            core.setOutput('errors', errors);
            core.setOutput('warnings', warnings);

            console.log(`Errors: ${errors}, Warnings: ${warnings}`);

  analyze-patterns:
    name: Analyze Log Patterns
    runs-on: ubuntu-latest
    needs: collect-logs
    outputs:
      patterns: ${{ steps.analyze.outputs.patterns }}
      recommendations: ${{ steps.analyze.outputs.recs }}
    steps:
      - name: Detect patterns
        id: analyze
        run: |
          errors="${{ needs.collect-logs.outputs.error_count }}"
          warnings="${{ needs.collect-logs.outputs.warning_count }}"

          patterns=""
          recs=""

          if [ "$errors" -gt 10 ]; then
            patterns="${patterns}high-error-rate,"
            recs="${recs}- Investigate spike in failures\n"
          fi

          if [ "$warnings" -gt 5 ]; then
            patterns="${patterns}frequent-cancellations,"
            recs="${recs}- Review cancelled workflows\n"
          fi

          echo "patterns=$patterns" >> $GITHUB_OUTPUT
          echo "recs<<EOF" >> $GITHUB_OUTPUT
          echo -e "$recs" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  create-insights-report:
    name: Create Insights Report
    runs-on: ubuntu-latest
    needs: [collect-logs, analyze-patterns]
    if: needs.collect-logs.outputs.error_count > 5
    steps:
      - name: Create issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ“Š Log Analysis Report - Action Required',
              body: `## Intelligent Log Analysis

              **Error Count:** ${{ needs.collect-logs.outputs.error_count }}
              **Warning Count:** ${{ needs.collect-logs.outputs.warning_count }}

              ### Detected Patterns
              ${{ needs.analyze-patterns.outputs.patterns }}

              ### Recommendations
              ${{ needs.analyze-patterns.outputs.recommendations }}

              ---
              ðŸ¤– Auto-generated by Intelligent Log Analyzer
              `,
              labels: ['logs', 'automated', 'insights']
            }).catch(() => {});

  log-analysis-summary:
    name: Log Analysis Summary
    runs-on: ubuntu-latest
    needs: [collect-logs, analyze-patterns]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# ðŸ“Š Intelligent Log Analysis" >> $GITHUB_STEP_SUMMARY
          echo "Errors: ${{ needs.collect-logs.outputs.error_count }}" >> $GITHUB_STEP_SUMMARY
          echo "Warnings: ${{ needs.collect-logs.outputs.warning_count }}" >> $GITHUB_STEP_SUMMARY
          echo "Patterns: ${{ needs.analyze-patterns.outputs.patterns }}" >> $GITHUB_STEP_SUMMARY
