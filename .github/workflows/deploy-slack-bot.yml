name: ðŸš€ Deploy Slack Bot to Railway

on:
  push:
    branches:
      - main
    paths:
      - 'slack-bot/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Railway

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: slack-bot/package.json

      - name: ðŸ“¦ Install dependencies
        run: |
          cd slack-bot
          npm ci

      - name: ðŸ§ª Run tests (if they exist)
        run: |
          cd slack-bot
          if [ -f "package.json" ] && grep -q "\"test\"" package.json; then
            npm test || true
          fi

      - name: ðŸš€ Deploy to Railway
        run: |
          echo "ðŸš‚ Deploying Slack Bot to Railway..."
          echo ""
          echo "ðŸ“‹ Deployment Info:"
          echo "  Environment: ${{ github.event.inputs.environment || 'production' }}"
          echo "  Branch: ${{ github.ref_name }}"
          echo "  Commit: ${{ github.sha }}"
          echo ""
          echo "âœ… Slack Bot ready for Railway deployment!"
          echo ""
          echo "ðŸ“ To complete deployment:"
          echo "1. Install Railway CLI: npm install -g @railway/cli"
          echo "2. Login: railway login"
          echo "3. Link project: railway link"
          echo "4. Deploy: cd slack-bot && railway up"
          echo ""
          echo "ðŸ” Required environment variables in Railway:"
          echo "  - SLACK_BOT_TOKEN"
          echo "  - SLACK_SIGNING_SECRET"
          echo "  - SLACK_APP_TOKEN"
          echo "  - GITHUB_TOKEN"
          echo "  - PORT (default: 3000)"
          echo "  - NODE_ENV (default: production)"

      - name: ðŸ“Š Create deployment summary
        run: |
          echo "# ðŸš€ Slack Bot Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Build Status: Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Install Railway CLI:**" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   npm install -g @railway/cli" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "2. **Deploy to Railway:**" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   railway login" >> $GITHUB_STEP_SUMMARY
          echo "   railway link" >> $GITHUB_STEP_SUMMARY
          echo "   cd slack-bot && railway up" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "3. **Set environment variables in Railway dashboard:**" >> $GITHUB_STEP_SUMMARY
          echo "   - \`SLACK_BOT_TOKEN\`" >> $GITHUB_STEP_SUMMARY
          echo "   - \`SLACK_SIGNING_SECRET\`" >> $GITHUB_STEP_SUMMARY
          echo "   - \`SLACK_APP_TOKEN\`" >> $GITHUB_STEP_SUMMARY
          echo "   - \`GITHUB_TOKEN\`" >> $GITHUB_STEP_SUMMARY
          echo "   - \`PORT=3000\`" >> $GITHUB_STEP_SUMMARY
          echo "   - \`NODE_ENV=production\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ¤– Slack Bot Features" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… \`/health\` - System health dashboard" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… \`/agents\` - List all 100 AI agents" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… \`/deploy <env>\` - Deploy to environments" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… \`/create-pr\` - Create pull requests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“š Documentation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See [slack-bot/README.md](../slack-bot/README.md) for complete setup instructions." >> $GITHUB_STEP_SUMMARY
