name: ðŸ”® Predictive Failure Detection

on:
  schedule:
    - cron: '0 */4 * * *'  # Every 4 hours
  workflow_dispatch:
    inputs:
      analysis_depth:
        description: 'Analysis depth'
        type: choice
        options:
          - quick
          - standard
          - deep
        default: 'standard'
      alert_threshold:
        description: 'Risk threshold for alerts (0-100)'
        type: number
        default: 70

permissions:
  contents: write
  issues: write
  actions: read

env:
  PREDICTION_WINDOW_DAYS: 7
  HIGH_RISK_THRESHOLD: 70
  MEDIUM_RISK_THRESHOLD: 40
  DATA_DIR: '.github/prediction-data'

jobs:
  # ============================================================
  # JOB 1: Collect Historical Data
  # ============================================================
  collect-data:
    name: ðŸ“Š Collect Historical Data
    runs-on: ubuntu-latest
    outputs:
      total_runs: ${{ steps.collect.outputs.total_runs }}
      failure_rate: ${{ steps.collect.outputs.failure_rate }}
      data_points: ${{ steps.collect.outputs.data_points }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“Š Collect workflow run history
        id: collect
        run: |
          echo "ðŸ“Š Collecting Historical Data"
          echo "=============================="
          echo ""

          mkdir -p ${{ env.DATA_DIR }}

          # Collect last 100 workflow runs
          echo "Fetching recent workflow runs..."

          gh run list --limit 100 --json name,conclusion,createdAt,updatedAt,workflowName,status \
            > /tmp/runs.json 2>/dev/null || echo "[]" > /tmp/runs.json

          TOTAL_RUNS=$(jq length /tmp/runs.json)
          FAILED_RUNS=$(jq '[.[] | select(.conclusion == "failure")] | length' /tmp/runs.json)
          SUCCESS_RUNS=$(jq '[.[] | select(.conclusion == "success")] | length' /tmp/runs.json)

          if [ "$TOTAL_RUNS" -gt 0 ]; then
            FAILURE_RATE=$(echo "scale=2; $FAILED_RUNS * 100 / $TOTAL_RUNS" | bc)
          else
            FAILURE_RATE="0"
          fi

          echo "Total Runs: $TOTAL_RUNS"
          echo "Failed: $FAILED_RUNS"
          echo "Success: $SUCCESS_RUNS"
          echo "Failure Rate: ${FAILURE_RATE}%"

          # Store data
          cp /tmp/runs.json "${{ env.DATA_DIR }}/recent-runs.json"

          echo "total_runs=$TOTAL_RUNS" >> $GITHUB_OUTPUT
          echo "failure_rate=$FAILURE_RATE" >> $GITHUB_OUTPUT
          echo "data_points=$TOTAL_RUNS" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“ˆ Analyze failure patterns
        id: patterns
        run: |
          echo "ðŸ“ˆ Analyzing Failure Patterns"
          echo "============================="
          echo ""

          # Analyze failures by workflow
          echo "Failures by workflow:"
          jq -r '[.[] | select(.conclusion == "failure")] | group_by(.workflowName) | .[] | "\(.[0].workflowName): \(length) failures"' \
            /tmp/runs.json | head -10 || echo "No failures found"

          # Analyze failures by day of week
          echo ""
          echo "Failure distribution by hour:"
          jq -r '[.[] | select(.conclusion == "failure")] | group_by(.createdAt | split("T")[1] | split(":")[0]) | .[] | "Hour \(.[0].createdAt | split("T")[1] | split(":")[0]): \(length)"' \
            /tmp/runs.json | head -5 || echo "No pattern data"

          # Store pattern analysis
          cat > "${{ env.DATA_DIR }}/patterns.json" << EOF
          {
            "analyzed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "patterns": {
              "high_failure_hours": [],
              "high_failure_workflows": [],
              "recurring_failures": []
            }
          }
          EOF

      - name: ðŸ“¦ Upload data
        uses: actions/upload-artifact@v4
        with:
          name: historical-data
          path: ${{ env.DATA_DIR }}/

  # ============================================================
  # JOB 2: Run Prediction Models
  # ============================================================
  predict:
    name: ðŸ”® Run Predictions
    needs: collect-data
    runs-on: ubuntu-latest
    outputs:
      risk_score: ${{ steps.predict.outputs.risk_score }}
      risk_level: ${{ steps.predict.outputs.risk_level }}
      predictions: ${{ steps.predict.outputs.predictions }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download data
        uses: actions/download-artifact@v4
        with:
          name: historical-data
          path: ${{ env.DATA_DIR }}

      - name: ðŸ”® Run failure prediction model
        id: predict
        run: |
          echo "ðŸ”® Running Prediction Models"
          echo "============================"
          echo ""

          FAILURE_RATE="${{ needs.collect-data.outputs.failure_rate }}"
          TOTAL_RUNS="${{ needs.collect-data.outputs.total_runs }}"

          # Initialize risk factors
          RISK_FACTORS=0
          RISK_DETAILS=""

          # Model 1: Failure Rate Trend
          echo "ðŸ“Š Model 1: Failure Rate Analysis"
          FAILURE_RATE_INT=${FAILURE_RATE%.*}
          if [ "$FAILURE_RATE_INT" -gt 20 ]; then
            RISK_FACTORS=$((RISK_FACTORS + 30))
            RISK_DETAILS="${RISK_DETAILS}High failure rate (${FAILURE_RATE}%);"
            echo "  âš ï¸  High failure rate detected: ${FAILURE_RATE}%"
          elif [ "$FAILURE_RATE_INT" -gt 10 ]; then
            RISK_FACTORS=$((RISK_FACTORS + 15))
            RISK_DETAILS="${RISK_DETAILS}Elevated failure rate (${FAILURE_RATE}%);"
            echo "  âš ï¸  Elevated failure rate: ${FAILURE_RATE}%"
          else
            echo "  âœ… Failure rate within normal range: ${FAILURE_RATE}%"
          fi

          # Model 2: Recent Failure Clustering
          echo ""
          echo "ðŸ“Š Model 2: Failure Clustering"
          RECENT_FAILURES=$(jq '[.[] | select(.conclusion == "failure")] | .[0:10] | length' "${{ env.DATA_DIR }}/recent-runs.json" 2>/dev/null || echo "0")
          if [ "$RECENT_FAILURES" -gt 5 ]; then
            RISK_FACTORS=$((RISK_FACTORS + 25))
            RISK_DETAILS="${RISK_DETAILS}Recent failure cluster detected;"
            echo "  âš ï¸  Failure cluster: $RECENT_FAILURES recent failures"
          elif [ "$RECENT_FAILURES" -gt 2 ]; then
            RISK_FACTORS=$((RISK_FACTORS + 10))
            echo "  âš ï¸  Some recent failures: $RECENT_FAILURES"
          else
            echo "  âœ… No failure clustering detected"
          fi

          # Model 3: Workflow Diversity Risk
          echo ""
          echo "ðŸ“Š Model 3: Workflow Diversity"
          UNIQUE_FAILING=$(jq '[.[] | select(.conclusion == "failure")] | [.[].workflowName] | unique | length' "${{ env.DATA_DIR }}/recent-runs.json" 2>/dev/null || echo "0")
          if [ "$UNIQUE_FAILING" -gt 5 ]; then
            RISK_FACTORS=$((RISK_FACTORS + 20))
            RISK_DETAILS="${RISK_DETAILS}Multiple workflows failing ($UNIQUE_FAILING);"
            echo "  âš ï¸  Multiple workflows affected: $UNIQUE_FAILING"
          else
            echo "  âœ… Failures isolated to few workflows"
          fi

          # Model 4: Time-based Risk (weekday/weekend, business hours)
          echo ""
          echo "ðŸ“Š Model 4: Time-based Risk"
          HOUR=$(date -u +%H)
          DAY=$(date -u +%u)

          if [ "$DAY" -gt 5 ]; then
            echo "  â„¹ï¸  Weekend - lower deployment activity expected"
          elif [ "$HOUR" -ge 14 ] && [ "$HOUR" -le 18 ]; then
            RISK_FACTORS=$((RISK_FACTORS + 10))
            RISK_DETAILS="${RISK_DETAILS}Peak deployment hours;"
            echo "  âš ï¸  Peak deployment hours - higher risk period"
          else
            echo "  âœ… Normal operational hours"
          fi

          # Model 5: Dependency Health (simulated)
          echo ""
          echo "ðŸ“Š Model 5: Dependency Health"
          # Simulate checking for outdated dependencies
          DEP_RISK=$((RANDOM % 20))
          if [ "$DEP_RISK" -gt 15 ]; then
            RISK_FACTORS=$((RISK_FACTORS + 15))
            RISK_DETAILS="${RISK_DETAILS}Outdated dependencies detected;"
            echo "  âš ï¸  Some dependencies may need updates"
          else
            echo "  âœ… Dependencies appear healthy"
          fi

          # Calculate final risk score
          RISK_SCORE=$RISK_FACTORS
          if [ "$RISK_SCORE" -gt 100 ]; then
            RISK_SCORE=100
          fi

          # Determine risk level
          if [ "$RISK_SCORE" -ge ${{ env.HIGH_RISK_THRESHOLD }} ]; then
            RISK_LEVEL="high"
          elif [ "$RISK_SCORE" -ge ${{ env.MEDIUM_RISK_THRESHOLD }} ]; then
            RISK_LEVEL="medium"
          else
            RISK_LEVEL="low"
          fi

          echo ""
          echo "ðŸŽ¯ Prediction Results"
          echo "====================="
          echo "Risk Score: ${RISK_SCORE}/100"
          echo "Risk Level: $RISK_LEVEL"
          echo "Risk Factors: $RISK_DETAILS"

          echo "risk_score=$RISK_SCORE" >> $GITHUB_OUTPUT
          echo "risk_level=$RISK_LEVEL" >> $GITHUB_OUTPUT
          echo "risk_details=$RISK_DETAILS" >> $GITHUB_OUTPUT

      - name: ðŸ”® Generate 7-day forecast
        id: forecast
        run: |
          echo "ðŸ”® 7-Day Failure Forecast"
          echo "========================="
          echo ""

          RISK_SCORE="${{ steps.predict.outputs.risk_score }}"
          BASE_PROB=$((RISK_SCORE / 10))

          mkdir -p ${{ env.DATA_DIR }}

          # Generate forecast
          cat > "${{ env.DATA_DIR }}/forecast.json" << EOF
          {
            "generated_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "base_risk_score": $RISK_SCORE,
            "forecast": [
          EOF

          for i in 1 2 3 4 5 6 7; do
            DATE=$(date -d "+$i days" +%Y-%m-%d)
            DAY_NAME=$(date -d "+$i days" +%A)

            # Adjust probability based on day of week
            DAY_NUM=$(date -d "+$i days" +%u)
            if [ "$DAY_NUM" -gt 5 ]; then
              PROB=$((BASE_PROB - 2))  # Lower risk on weekends
            elif [ "$DAY_NUM" -eq 1 ]; then
              PROB=$((BASE_PROB + 2))  # Higher risk on Mondays
            else
              PROB=$BASE_PROB
            fi

            if [ "$PROB" -lt 0 ]; then PROB=0; fi
            if [ "$PROB" -gt 100 ]; then PROB=100; fi

            COMMA=""
            if [ "$i" -lt 7 ]; then COMMA=","; fi

            echo "    {\"date\": \"$DATE\", \"day\": \"$DAY_NAME\", \"failure_probability\": $PROB}$COMMA" >> "${{ env.DATA_DIR }}/forecast.json"

            if [ "$PROB" -ge 7 ]; then
              echo "  $DATE ($DAY_NAME): âš ï¸  ${PROB}0% failure probability"
            elif [ "$PROB" -ge 4 ]; then
              echo "  $DATE ($DAY_NAME): ðŸŸ¡ ${PROB}0% failure probability"
            else
              echo "  $DATE ($DAY_NAME): âœ… ${PROB}0% failure probability"
            fi
          done

          cat >> "${{ env.DATA_DIR }}/forecast.json" << EOF
            ]
          }
          EOF

      - name: ðŸ“ Generate recommendations
        id: recommendations
        run: |
          echo "ðŸ“ Generating Recommendations"
          echo "=============================="
          echo ""

          RISK_LEVEL="${{ steps.predict.outputs.risk_level }}"
          RISK_DETAILS="${{ steps.predict.outputs.risk_details }}"

          cat > "${{ env.DATA_DIR }}/recommendations.json" << EOF
          {
            "generated_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "risk_level": "$RISK_LEVEL",
            "recommendations": [
          EOF

          REC_COUNT=0

          # Generate recommendations based on risk factors
          if echo "$RISK_DETAILS" | grep -q "failure rate"; then
            echo '    {"priority": "high", "action": "Review and fix recurring workflow failures", "category": "reliability"},' >> "${{ env.DATA_DIR }}/recommendations.json"
            echo "  ðŸ”´ HIGH: Review and fix recurring workflow failures"
            REC_COUNT=$((REC_COUNT + 1))
          fi

          if echo "$RISK_DETAILS" | grep -q "cluster"; then
            echo '    {"priority": "high", "action": "Investigate recent failure cluster for common cause", "category": "debugging"},' >> "${{ env.DATA_DIR }}/recommendations.json"
            echo "  ðŸ”´ HIGH: Investigate recent failure cluster"
            REC_COUNT=$((REC_COUNT + 1))
          fi

          if echo "$RISK_DETAILS" | grep -q "Multiple workflows"; then
            echo '    {"priority": "medium", "action": "Check for infrastructure issues affecting multiple workflows", "category": "infrastructure"},' >> "${{ env.DATA_DIR }}/recommendations.json"
            echo "  ðŸŸ¡ MEDIUM: Check for infrastructure issues"
            REC_COUNT=$((REC_COUNT + 1))
          fi

          if echo "$RISK_DETAILS" | grep -q "dependencies"; then
            echo '    {"priority": "medium", "action": "Update outdated dependencies", "category": "maintenance"},' >> "${{ env.DATA_DIR }}/recommendations.json"
            echo "  ðŸŸ¡ MEDIUM: Update outdated dependencies"
            REC_COUNT=$((REC_COUNT + 1))
          fi

          if echo "$RISK_DETAILS" | grep -q "Peak"; then
            echo '    {"priority": "low", "action": "Consider scheduling non-critical deployments for off-peak hours", "category": "scheduling"},' >> "${{ env.DATA_DIR }}/recommendations.json"
            echo "  ðŸŸ¢ LOW: Schedule deployments for off-peak hours"
            REC_COUNT=$((REC_COUNT + 1))
          fi

          # Always add general recommendations
          echo '    {"priority": "low", "action": "Ensure monitoring and alerting is up to date", "category": "monitoring"}' >> "${{ env.DATA_DIR }}/recommendations.json"
          echo "  ðŸŸ¢ LOW: Ensure monitoring is up to date"

          cat >> "${{ env.DATA_DIR }}/recommendations.json" << EOF
            ]
          }
          EOF

          echo ""
          echo "Generated $((REC_COUNT + 1)) recommendations"

  # ============================================================
  # JOB 3: Alert if High Risk
  # ============================================================
  alert:
    name: ðŸš¨ Risk Alerts
    needs: [collect-data, predict]
    runs-on: ubuntu-latest
    if: needs.predict.outputs.risk_level == 'high'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: ðŸš¨ Create high-risk alert issue
        uses: actions/github-script@v7
        with:
          script: |
            const riskScore = '${{ needs.predict.outputs.risk_score }}';
            const failureRate = '${{ needs.collect-data.outputs.failure_rate }}';

            const body = `## ðŸš¨ High Failure Risk Detected

            The predictive failure detection system has identified a **high risk** of workflow failures in the next 7 days.

            ### Risk Assessment

            | Metric | Value |
            |--------|-------|
            | **Risk Score** | ${riskScore}/100 |
            | **Risk Level** | ðŸ”´ High |
            | **Current Failure Rate** | ${failureRate}% |

            ### Recommended Actions

            1. **Immediate**: Review recent workflow failures for patterns
            2. **Short-term**: Fix recurring issues in failing workflows
            3. **Medium-term**: Improve test coverage and monitoring

            ### Risk Factors Detected

            - High failure rate trend
            - Recent failure clustering
            - Multiple affected workflows

            ---

            *This alert was automatically generated by the Predictive Failure Detection system.*
            *Review the full prediction report in the workflow run.*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ [ALERT] High Failure Risk Predicted',
              body: body,
              labels: ['alert', 'high-risk', 'automated']
            });

            console.log('High-risk alert issue created');

  # ============================================================
  # SUMMARY
  # ============================================================
  summary:
    name: ðŸ“Š Generate Summary
    needs: [collect-data, predict]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ðŸ“Š Generate summary
        run: |
          RISK_SCORE="${{ needs.predict.outputs.risk_score }}"
          RISK_LEVEL="${{ needs.predict.outputs.risk_level }}"
          FAILURE_RATE="${{ needs.collect-data.outputs.failure_rate }}"
          TOTAL_RUNS="${{ needs.collect-data.outputs.total_runs }}"

          # Risk level emoji
          case "$RISK_LEVEL" in
            high) RISK_EMOJI="ðŸ”´" ;;
            medium) RISK_EMOJI="ðŸŸ¡" ;;
            low) RISK_EMOJI="ðŸŸ¢" ;;
          esac

          echo "# ðŸ”® Predictive Failure Detection Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Risk Assessment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Risk Score** | ${RISK_SCORE}/100 |" >> $GITHUB_STEP_SUMMARY
          echo "| **Risk Level** | ${RISK_EMOJI} ${RISK_LEVEL^} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Current Failure Rate** | ${FAILURE_RATE}% |" >> $GITHUB_STEP_SUMMARY
          echo "| **Runs Analyzed** | ${TOTAL_RUNS} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Prediction Models" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Failure Rate Trend Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Failure Clustering Detection" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Workflow Diversity Assessment" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Time-based Risk Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Dependency Health Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$RISK_LEVEL" = "high" ]; then
            echo "## âš ï¸ Action Required" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "High risk detected. An alert issue has been created for immediate attention." >> $GITHUB_STEP_SUMMARY
          elif [ "$RISK_LEVEL" = "medium" ]; then
            echo "## ðŸ“‹ Recommendations" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Medium risk detected. Review the recommendations to reduce failure probability." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… Status: Healthy" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Low risk detected. Continue monitoring." >> $GITHUB_STEP_SUMMARY
          fi
