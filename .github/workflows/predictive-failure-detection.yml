name: Predictive Failure Detection

on:
  schedule:
    - cron: '0 */4 * * *'  # Every 4 hours
  workflow_dispatch:

permissions:
  issues: write
  checks: write

jobs:
  collect-metrics:
    name: Collect System Metrics
    runs-on: ubuntu-latest
    outputs:
      failure_probability: ${{ steps.predict.outputs.probability }}
      risk_level: ${{ steps.predict.outputs.risk }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Analyze patterns
        id: predict
        uses: actions/github-script@v7
        with:
          script: |
            // Get recent workflow runs
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            const recentFailures = runs.workflow_runs.filter(r => 
              r.conclusion === 'failure'
            ).length;
            
            const failureRate = (recentFailures / runs.workflow_runs.length) * 100;
            const probability = Math.min(failureRate * 2, 100);
            
            let risk = 'low';
            if (probability > 60) risk = 'high';
            else if (probability > 30) risk = 'medium';
            
            core.setOutput('probability', Math.round(probability));
            core.setOutput('risk', risk);
            
            console.log(`Failure probability: ${probability}%`);
            console.log(`Risk level: ${risk}`);

  create-prediction-report:
    name: Create Prediction Report
    runs-on: ubuntu-latest
    needs: collect-metrics
    steps:
      - name: Generate alert
        if: needs.collect-metrics.outputs.risk_level != 'low'
        uses: actions/github-script@v7
        with:
          script: |
            const probability = '${{ needs.collect-metrics.outputs.failure_probability }}';
            const risk = '${{ needs.collect-metrics.outputs.risk_level }}';
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `âš ï¸ Predictive Alert: ${risk.toUpperCase()} risk of failures`,
              body: `## Predictive Failure Detection Alert
              
              **Failure Probability:** ${probability}%
              **Risk Level:** ${risk}
              
              Our predictive models indicate an increased risk of failures.
              
              ### Recommended Actions
              - Review recent failed workflows
              - Check resource utilization
              - Update dependencies
              - Run diagnostic tests
              
              ---
              ðŸ¤– Auto-generated by Predictive Failure Detection
              `,
              labels: ['alert', 'predictive', `risk-${risk}`]
            }).catch(() => {});
      
      - name: Generate summary
        run: |
          echo "# ðŸ”® Predictive Failure Detection" >> $GITHUB_STEP_SUMMARY
          echo "Failure probability: ${{ needs.collect-metrics.outputs.failure_probability }}%" >> $GITHUB_STEP_SUMMARY
          echo "Risk level: ${{ needs.collect-metrics.outputs.risk_level }}" >> $GITHUB_STEP_SUMMARY
